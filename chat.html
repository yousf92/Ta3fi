<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØºØ±ÙØ© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ù„Ø§ Ø£Ø¨Ø±Ø­ Ø­ØªÙ‰ Ø£Ø¨Ù„Øº Ø¨ÙˆØ§Ø³Ø·Ø© ÙŠÙˆØ³Ù Ø§Ù„ÙƒØ±Ø¯ÙŠ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <style>
        html, body {
            height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
        body {
            background-color: #f0f2f5; font-family: 'Tajawal', sans-serif;
        }
        .chat-wrapper {
            display: flex; justify-content: center; align-items: center; height: 100%;
        }
        .chat-container {
            display: flex; flex-direction: column; height: 100%;
            width: 100%; max-width: 800px; background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1); border-radius: 0; position: relative;
        }
        @media (min-width: 801px) {
            .chat-container { height: 95vh; border-radius: 15px; }
        }
        .chat-header {
            padding: 1rem;
            background-image: linear-gradient(rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.35)), url('https://images.unsplash.com/photo-1433086966358-54859d0ed716?q=80&w=1974&auto=format&fit=crop');
            background-size: cover; background-position: center; border-bottom: none;
            flex-shrink: 0; color: white;
        }
        .chat-header h5, .chat-header #user-display-name { color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        #pinned-message-container { padding: 8px 15px; background-color: #fffbe6; border-bottom: 1px solid #ffe58f; display: none; font-size: 0.9rem; flex-shrink: 0; position: relative; }
        #pinned-message-clickable-area { cursor: pointer; padding-right: 25px; }
        #pinned-by-text { font-weight: bold; color: #664d03; display: block; font-size: 0.8rem; }
        #pinned-message-text { color: #856404; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; display: block; }
        #unpin-button { position: absolute; top: 50%; right: 10px; transform: translateY(-50%); cursor: pointer; font-size: 1.2rem; color: #856404; z-index: 2; }
        .main-content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
        #chat-section { display: flex; flex-direction: column; height: 100%; position: relative; }
        #messages-box {
            flex-grow: 1; overflow-y: auto; padding: 20px;
            background-image: url('https://images.unsplash.com/photo-1500964757637-c85e8a162699?q=80&w=2103&auto=format&fit=crop');
            background-size: cover; background-position: center; user-select: none;
            display: flex; flex-direction: column;
        }
        .message-content { user-select: text; -webkit-user-select: text; }
        .message { margin-bottom: 15px; display: flex; align-items: flex-start; position: relative; padding-bottom: 35px; max-width: 95%; transition: transform 0.3s ease; }
        .message.own { align-self: flex-end; flex-direction: row-reverse; }
        .message.other { align-self: flex-start; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-left: 10px; flex-shrink: 0; }
        .message.own .avatar { margin-left: 0; margin-right: 10px; }
        .message-bubble { display: flex; flex-direction: column; max-width: calc(100% - 50px); }
        .message-content { padding: 8px 12px; border-radius: 18px; max-width: 100%; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; display: flex; flex-direction: column; }
        .message.own .message-content { background-color: #005c4b; color: white; border-bottom-right-radius: 5px; }
        .message.other .message-content { background-color: #202c33; color: white; border-bottom-left-radius: 5px; }
        .sender { font-weight: bold; font-size: 0.9rem; margin-bottom: 4px; color: #53bdeb; }
        .timestamp-wrapper { align-self: flex-end; display: flex; align-items: center; margin-top: 4px; margin-left: 15px; }
        .timestamp { font-size: 0.75rem; color: #a0a0a0; }
        .edited-badge { font-size: 0.7rem; color: #a0a0a0; margin-right: 5px; }
        .message-actions { position: absolute; bottom: 0; z-index: 10; background-color: white; padding: 5px 10px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); font-size: 1rem; display: none; align-items: center; gap: 12px; white-space: nowrap; }
        .message.own .message-actions { right: 50px; }
        .message.other .message-actions { left: 50px; }
        .message:hover .message-actions { display: flex; }
        .message-actions a { cursor: pointer; color: #2a3942; text-decoration: none; position: relative; }
        .message-actions a:hover { color: #000; }
        .reply-preview { background-color: #2a3942; padding: 8px 12px; border-bottom: 1px solid #3a4a55; font-size: 0.9rem; display: none; position: relative; flex-shrink: 0; }
        #reply-preview-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .replied-to-box { background-color: rgba(0,0,0,0.2); padding: 8px; margin-bottom: 8px; border-radius: 10px; border-left: 3px solid #53bdeb; font-size: 0.9rem; }
        .reactions-container { position: absolute; top: -35px; background-color: #202c33; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; padding: 5px; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 10; }
        .message.own .reactions-container { left: 0; }
        .message.other .reactions-container { right: 0; }
        .message-content:hover .reactions-container { opacity: 1; visibility: visible; }
        .reaction-emoji { cursor: pointer; font-size: 1.2rem; margin: 0 4px; transition: transform 0.1s; }
        .reaction-emoji:hover { transform: scale(1.3); }
        .message-reactions { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .reaction-chip { background-color: #2a3942; border-radius: 10px; padding: 2px 8px; font-size: 0.8rem; display: flex; align-items: center; }
        .message.own .reaction-chip { background-color: #004a3c; }
        .mute-dropdown { display: none; position: absolute; background-color: #202c33; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 5px; padding: 5px 0; bottom: 100%; }
        .message.own .mute-dropdown { right: 0; }
        .message.other .mute-dropdown { left: 0; }
        .mute-dropdown a { color: white; padding: 8px 12px; text-decoration: none; display: block; font-size: 0.9rem; }
        .mute-dropdown a:hover { background-color: #2a3942; }
        .show-dropdown { display: block; }
        #chat-footer { flex-shrink: 0; }
        #chat-footer .card-footer { background-color: #ffffff; border-top: 1px solid #e9ecef; padding: 10px 15px; }
        #chat-footer .input-group { background-color: #f1f8f6; border-radius: 25px; padding: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        #message-input { resize: none; overflow-y: auto; max-height: 120px; border: none; box-shadow: none; background-color: transparent; }
        #send-button { background-color: #009688; border-radius: 50%; width: 45px; height: 45px; border: none; display: flex; align-items: center; justify-content: center; }
        #mention-notification { position: absolute; bottom: 15px; right: 20px; width: 40px; height: 40px; background-color: #53bdeb; color: white; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 1.5rem; font-weight: bold; cursor: pointer; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .edit-modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 1050; }
        .edit-modal-content { background-color: #3e4a54; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); color: white; }
        .edit-modal-content textarea { width: 100%; min-height: 100px; background-color: #2a3942; color: white; border: 1px solid #53bdeb; border-radius: 5px; padding: 10px; margin-bottom: 15px; resize: vertical; }
        .edit-modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
    </style>
</head>
<body>
    <div class="chat-wrapper">
        <div class="chat-container">
            <div class="chat-header">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© Ù„Ø§ Ø£Ø¨Ø±Ø­ Ø­ØªÙ‰ Ø£Ø¨Ù„Øº</h5>
                        <small id="user-display-name" class="text-muted"></small>
                    </div>
                    <a href="main.html" class="btn" style="color: white; font-size: 1.5rem;" aria-label="Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©">
                        <i class="bi bi-arrow-right"></i>
                    </a>
                    </div>
                <ul class="nav nav-pills nav-fill mt-3" style="display: none;">
                    <li class="nav-item"><a class="nav-link active" href="#">Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©</a></li>
                </ul>
            </div>
            <div id="pinned-message-container">
                <i id="unpin-button" class="bi bi-x-circle-fill"></i>
                <div id="pinned-message-clickable-area">
                    <span id="pinned-by-text"></span>
                    <span id="pinned-message-text"></span>
                </div>
            </div>
            <div class="main-content">
                <div id="chat-section">
                    <div id="messages-box"></div>
                    <div id="mention-notification" title="Ù„Ø¯ÙŠÙƒ Ø±Ø¯ Ø¬Ø¯ÙŠØ¯">@</div>
                </div>
            </div>
            <div id="chat-footer">
                <div id="reply-preview" class="reply-preview">
                    <div id="cancel-reply" class="cancel-reply">&times;</div>
                    <div class="reply-preview-sender" id="reply-preview-sender"></div>
                    <div id="reply-preview-text" class="reply-preview-text"></div>
                </div>
                <div class="card-footer p-3">
                    <div class="input-group">
                        <textarea id="message-input" class="form-control" placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ..." rows="1"></textarea>
                        <button id="send-button" class="btn"><i class="bi bi-send-fill"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc, getDocs, deleteDoc, setDoc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAGgZmhJ_mMezlf7xElisvzJ8l9D758d4g",
            authDomain: "my-chat-app-daaf8.firebaseapp.com",
            projectId: "my-chat-app-daaf8",
            storageBucket: "my-chat-app-daaf8.firebasestorage.app",
            messagingSenderId: "789086064752",
            appId: "1:789086064752:web:d081f1b6832dabca1d64b5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUserRole = 'user';
        let replyToMessage = null;
        const userProfiles = {};

        const userDisplayName = document.getElementById('user-display-name');
        const messagesBox = document.getElementById('messages-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const replyPreview = document.getElementById('reply-preview');
        const cancelReplyButton = document.getElementById('cancel-reply');
        const mentionNotification = document.getElementById('mention-notification');
        const pinnedMessageContainer = document.getElementById('pinned-message-container');
        const pinnedByText = document.getElementById('pinned-by-text');
        const pinnedMessageText = document.getElementById('pinned-message-text');
        const unpinButton = document.getElementById('unpin-button');
        const pinnedMessageClickableArea = document.getElementById('pinned-message-clickable-area');

        async function loadUserProfiles() {
            const usersCol = collection(db, "users");
            const userSnapshot = await getDocs(usersCol);
            userSnapshot.forEach((doc) => {
                userProfiles[doc.id] = doc.data();
            });
        }

        async function checkUserStatus(userId) {
            const userDocRef = doc(db, "users", userId);
            const userDoc = await getDoc(userDocRef);
            if (userDoc.exists()) {
                const userData = userDoc.data();
                if (userData.isBanned) {
                    alert("Ù„Ù‚Ø¯ ØªÙ… Ø­Ø¸Ø±Ùƒ Ù…Ù† Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©.");
                    signOut(auth);
                    return 'banned';
                }
                if (userData.mutedUntil && userData.mutedUntil.toDate() > new Date()) {
                    return 'muted';
                }
                currentUserRole = userData.role || 'user';
            } else {
                await setDoc(userDocRef, { role: 'user' }, { merge: true });
                currentUserRole = 'user';
            }
            return 'active';
        }

        onAuthStateChanged(auth, async user => {
            if (user && user.emailVerified) {
                const status = await checkUserStatus(user.uid);
                if (status === 'banned') return;
                
                let roleText = '';
                if (currentUserRole === 'developer') roleText = 'â­ (Ù…Ø·ÙˆØ±)';
                else if (currentUserRole === 'admin') roleText = 'ğŸ›¡ï¸ (Ù…Ø´Ø±Ù)';

                userDisplayName.textContent = `Ù…Ø±Ø­Ø¨Ø§ØŒ ${user.displayName || user.email} ${roleText}`;
                
                await loadUserProfiles();
                loadMessages();
                loadPinnedMessage();
            } else {
                window.location.href = 'index.html';
            }
        });
        
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !auth.currentUser) return;
            const userStatus = await checkUserStatus(auth.currentUser.uid);
            if (userStatus === 'muted') { alert("Ø£Ù†Øª Ù…ÙƒØªÙˆÙ… Ø­Ø§Ù„ÙŠØ§ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø±Ø³Ø§Ù„ Ø±Ø³Ø§Ø¦Ù„."); return; }
            const messageData = { text, senderName: auth.currentUser.displayName || auth.currentUser.email, senderId: auth.currentUser.uid, senderRole: currentUserRole, createdAt: serverTimestamp() };
            if (replyToMessage) { messageData.replyTo = replyToMessage; }
            await addDoc(collection(db, "messages"), messageData);
            messageInput.value = ""; 
            cancelReply();
            messageInput.style.height = 'auto';
        }
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => { 
            if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
        });
        messageInput.addEventListener('input', () => {
            messageInput.style.height = 'auto';
            messageInput.style.height = (messageInput.scrollHeight) + 'px';
        });
        
        function cancelReply() { replyToMessage = null; replyPreview.style.display = 'none'; }
        cancelReplyButton.addEventListener('click', cancelReply);

        function loadMessages() {
            const q = query(collection(db, "messages"), orderBy("createdAt"));
            onSnapshot(q, (snapshot) => {
                const wasScrolledToBottom = messagesBox.scrollHeight - messagesBox.clientHeight <= messagesBox.scrollTop + 150;
                messagesBox.innerHTML = "";
                snapshot.forEach(messageDoc => {
                    const msg = messageDoc.data(); const msgId = messageDoc.id; const isOwn = msg.senderId === auth.currentUser.uid;
                    const msgDiv = document.createElement('div'); 
                    msgDiv.className = `message ${isOwn ? 'own' : 'other'}`;
                    msgDiv.id = `message-${msgId}`;
                    msgDiv.dataset.senderName = msg.senderName;
                    msgDiv.dataset.senderId = msg.senderId;
                    msgDiv.dataset.text = msg.text;

                    const senderProfile = userProfiles[msg.senderId] || {};
                    const photoURL = senderProfile.photoURL || 'https://ssl.gstatic.com/images/branding/product/1x/avatar_circle_blue_512dp.png';
                    const avatarHtml = `<img src="${photoURL}" alt="${msg.senderName}" class="avatar">`;

                    const messageBubble = document.createElement('div');
                    messageBubble.className = 'message-bubble';
                    
                    const time = msg.createdAt ? new Date(msg.createdAt.toDate()).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '';
                    const canModerate = currentUserRole === 'developer' || currentUserRole === 'admin';
                    
                    let controls = '';
                    const pinButton = canModerate ? `<a onclick="window.pinMessage('${msgId}')" title="ØªØ«Ø¨ÙŠØª"><i class="bi bi-pin-angle-fill"></i></a>` : '';
                    const replyButton = `<a onclick="window.setReplyWrapper('${msgId}')" title="Ø±Ø¯"><i class="bi bi-reply-fill"></i></a>`;
                    const copyButton = `<a onclick="window.copyMessageText('${msgId}')" title="Ù†Ø³Ø®"><i class="bi bi-clipboard"></i></a>`;
                    
                    if (isOwn) {
                        controls = `<div class="message-actions">${copyButton}${replyButton}<a onclick="window.editMessage('${msgId}', \`${msg.text.replace(/`/g, '\\`')}\`)" title="ØªØ¹Ø¯ÙŠÙ„"><i class="bi bi-pencil-fill"></i></a><a onclick="window.deleteOwnMessage('${msgId}')" title="Ø­Ø°Ù"><i class="bi bi-trash-fill"></i></a>${pinButton}</div>`;
                    } else if (canModerate) {
                        const isTargetDeveloper = msg.senderRole === 'developer';
                        const isTargetAdmin = msg.senderRole === 'admin';
                        let actionButtons = `${copyButton}${replyButton}<a onclick="window.deleteOtherMessage('${msgId}')" title="Ø­Ø°Ù"><i class="bi bi-trash-fill"></i></a>`;
                        if (currentUserRole === 'developer' && !isTargetDeveloper) {
                            actionButtons += `<a onclick="window.toggleAdminRole('${msg.senderId}', '${msg.senderName}')" title="ØªØºÙŠÙŠØ± Ø¯ÙˆØ± Ø§Ù„Ù…Ø´Ø±Ù"><i class="bi bi-shield-fill"></i></a>`;
                        }
                        actionButtons += pinButton;
                        if (!isTargetAdmin && !isTargetDeveloper) {
                            const muteDropdownId = `mute-dropdown-${msgId}`;
                            const muteOptions = `<div id="${muteDropdownId}" class="mute-dropdown">
                                <a href="#" onclick="window.muteUser('${msg.senderId}', '${msg.senderName}', 1)">Ø¯Ù‚ÙŠÙ‚Ø© ÙˆØ§Ø­Ø¯Ø©</a>
                                <a href="#" onclick="window.muteUser('${msg.senderId}', '${msg.senderName}', 5)">5 Ø¯Ù‚Ø§Ø¦Ù‚</a>
                                <a href="#" onclick="window.muteUser('${msg.senderId}', '${msg.senderName}', 15)">Ø±Ø¨Ø¹ Ø³Ø§Ø¹Ø©</a>
                                <a href="#" onclick="window.muteUser('${msg.senderId}', '${msg.senderName}', 1440)">ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯</a>
                                <a href="#" onclick="window.unmuteUser('${msg.senderId}', '${msg.senderName}')" style="color: #00a884;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙƒØªÙ…</a>
                            </div>`;
                            const muteButton = `<a onclick="event.stopPropagation(); window.toggleMuteDropdown('${muteDropdownId}')" title="ÙƒØªÙ…"><i class="bi bi-bell-slash-fill"></i></a>`;
                            const banButton = `<a onclick="window.banUser('${msg.senderId}', '${msg.senderName}')" title="Ø­Ø¸Ø±"><i class="bi bi-slash-circle-fill"></i></a>`;
                            actionButtons += `${muteButton}${banButton}${muteOptions}`;
                        }
                        controls = `<div class="message-actions">${actionButtons}</div>`;
                    } else {
                        controls = `<div class="message-actions">${copyButton}${replyButton}</div>`;
                    }

                    const editedBadge = msg.isEdited ? `<span class="edited-badge">(ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)</span>` : '';
                    let roleBadge = '';
                    if (msg.senderRole === 'developer') roleBadge = 'â­ (Ù…Ø·ÙˆØ±)';
                    else if (msg.senderRole === 'admin') roleBadge = 'ğŸ›¡ï¸ (Ù…Ø´Ø±Ù)';
                    const senderNameDisplay = `${msg.senderName} ${roleBadge}`;
                    
                    let repliedToHtml = '';
                    if (msg.replyTo) { repliedToHtml = `<div class="replied-to-box"><div class="replied-to-sender">${msg.replyTo.senderName}</div><div class="replied-to-text">${msg.replyTo.text}</div></div>`; }
                    
                    const availableReactions = ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ˜®', 'ğŸ˜¢', 'ğŸ™'];
                    let reactionsContainerHtml = '<div class="reactions-container">';
                    availableReactions.forEach(emoji => { reactionsContainerHtml += `<span class="reaction-emoji" onclick="window.toggleReaction('${msgId}', '${emoji}')">${emoji}</span>`; });
                    reactionsContainerHtml += '</div>';

                    let displayedReactionsHtml = '<div class="message-reactions">';
                    if (msg.reactions && msg.reactions.length > 0) { 
                        const reactionGroups = msg.reactions.reduce((acc, r) => { acc[r.emoji] = (acc[r.emoji] || 0) + 1; return acc; }, {}); 
                        for (const e in reactionGroups) { 
                            displayedReactionsHtml += `<div class="reaction-chip">${e} ${reactionGroups[e]}</div>`; 
                        } 
                    }
                    displayedReactionsHtml += '</div>';

                    const messageContentHtml = `
                        <div class="message-content">
                            ${reactionsContainerHtml}
                            ${!isOwn ? `<div class="sender">${senderNameDisplay}</div>` : ''}
                            ${repliedToHtml}
                            <div class="message-text">${msg.text}</div>
                            <div class="timestamp-wrapper">
                                <span class="timestamp">${time}</span>
                                ${editedBadge}
                            </div>
                            ${displayedReactionsHtml}
                        </div>`;
                    
                    messageBubble.innerHTML = messageContentHtml + controls;
                    msgDiv.innerHTML = avatarHtml;
                    msgDiv.appendChild(messageBubble);
                    messagesBox.appendChild(msgDiv);
                });
                
                snapshot.docChanges().forEach(change => {
                    if (change.type === "added") {
                        const msg = change.doc.data();
                        if (auth.currentUser && msg.replyTo && msg.replyTo.senderId === auth.currentUser.uid && msg.senderId !== auth.currentUser.uid) {
                            if (!document.hasFocus() || !wasScrolledToBottom) {
                                mentionNotification.style.display = 'flex';
                                mentionNotification.dataset.messageId = change.doc.id;
                            }
                        }
                    }
                });
                
                if (wasScrolledToBottom) {
                    messagesBox.scrollTop = messagesBox.scrollHeight;
                }
            });
        }
        
        const pinnedDocRef = doc(db, "chat_config", "pinned_message");
        
        window.pinMessage = async (messageId) => {
            const messageDoc = await getDoc(doc(db, "messages", messageId));
            if (!messageDoc.exists()) return;
            const messageData = messageDoc.data();
            await setDoc(pinnedDocRef, { messageId: messageId, text: messageData.text, senderName: messageData.senderName, pinnedBy: auth.currentUser.displayName, pinnedAt: serverTimestamp() });
        };

        unpinButton.addEventListener('click', async (e) => {
            e.stopPropagation();
            await setDoc(pinnedDocRef, { messageId: null, text: null, senderName: null, pinnedBy: null });
        });

        function loadPinnedMessage() {
            onSnapshot(pinnedDocRef, (doc) => {
                if (doc.exists() && doc.data().text) {
                    const data = doc.data();
                    pinnedByText.textContent = `ØªÙ… Ø§Ù„ØªØ«Ø¨ÙŠØª Ø¨ÙˆØ§Ø³Ø·Ø©: ${data.pinnedBy}`;
                    pinnedMessageText.textContent = `${data.senderName}: ${data.text}`;
                    pinnedMessageContainer.style.display = 'block';
                    pinnedMessageContainer.dataset.messageId = data.messageId;
                    unpinButton.style.display = (currentUserRole === 'developer' || currentUserRole === 'admin') ? 'block' : 'none';
                } else {
                    pinnedMessageContainer.style.display = 'none';
                    pinnedMessageContainer.dataset.messageId = '';
                }
            });
        }

        pinnedMessageClickableArea.addEventListener('click', () => {
            const messageId = pinnedMessageContainer.dataset.messageId;
            if (!messageId) return;
            const messageElement = document.getElementById(`message-${messageId}`);
            if (messageElement) {
                messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                messageElement.style.transition = 'background-color 0.5s';
                messageElement.style.backgroundColor = 'rgba(255, 255, 0, 0.3)';
                setTimeout(() => { messageElement.style.backgroundColor = ''; }, 2000);
            }
        });

        mentionNotification.addEventListener('click', () => {
            const messageId = mentionNotification.dataset.messageId;
            if (!messageId) return;
            const messageElement = document.getElementById(`message-${messageId}`);
            if (messageElement) {
                messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                messageElement.style.transition = 'background-color 0.5s';
                messageElement.style.backgroundColor = 'rgba(83, 189, 235, 0.3)';
                setTimeout(() => { messageElement.style.backgroundColor = ''; }, 2500);
            }
            mentionNotification.style.display = 'none';
        });

        messagesBox.addEventListener('scroll', () => {
            if (mentionNotification.style.display !== 'none') {
                const isNearBottom = messagesBox.scrollHeight - messagesBox.clientHeight <= messagesBox.scrollTop + 150;
                if (isNearBottom) {
                    mentionNotification.style.display = 'none';
                }
            }
        });

        window.toggleMuteDropdown = (id) => {
            event.stopPropagation();
            document.querySelectorAll(".mute-dropdown").forEach(d => {
                if(d.id !== id) d.classList.remove('show-dropdown');
            });
            document.getElementById(id).classList.toggle("show-dropdown");
        }
        window.onclick = (e) => { 
            if (!e.target.matches('.bi-bell-slash-fill')) { 
                document.querySelectorAll(".mute-dropdown.show-dropdown").forEach(d => d.classList.remove('show-dropdown')); 
            } 
        }
        
        window.muteUser = async (uid, name, min) => { if (!['developer', 'admin'].includes(currentUserRole)) return; await setDoc(doc(db, "users", uid), { mutedUntil: new Date(Date.now() + min * 60000) }, { merge: true }); alert(`ØªÙ… ÙƒØªÙ… ${name} Ù„Ù…Ø¯Ø© ${min} Ø¯Ù‚ÙŠÙ‚Ø©.`); };
        window.unmuteUser = async (uid, name) => { if (!['developer', 'admin'].includes(currentUserRole)) return; await setDoc(doc(db, "users", uid), { mutedUntil: null }, { merge: true }); alert(`ØªÙ… Ø¥Ù„ØºØ§Ø¡ ÙƒØªÙ… ${name}.`); };
        
        function setReplyFromElement(el) {
            const msgId = el.id.replace('message-', '');
            const senderName = el.dataset.senderName;
            const senderId = el.dataset.senderId;
            const text = el.dataset.text;

            if(senderName && senderId && text){
                replyToMessage = { messageId: msgId, senderName, senderId, text }; 
                document.getElementById('reply-preview-sender').textContent = `Ø§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ ${senderName}`; 
                document.getElementById('reply-preview-text').textContent = text; 
                replyPreview.style.display = 'block'; 
                messageInput.focus(); 
            }
        }
        
        window.setReplyWrapper = (msgId) => {
            event.stopPropagation();
            const el = document.getElementById(`message-${msgId}`);
            if (el) setReplyFromElement(el);
        };
        
        window.copyMessageText = async (msgId) => {
            const messageElement = document.getElementById(`message-${msgId}`);
            if (messageElement) {
                const textElement = messageElement.querySelector('.message-text');
                if (textElement) {
                    try {
                        await navigator.clipboard.writeText(textElement.innerText);
                        alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù†Øµ!"); 
                    } catch (err) { 
                        console.error('Failed to copy text: ', err); 
                        alert("ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ù†Øµ.");
                    }
                }
            }
        };
        
        function showEditModal(id, currentText) {
            const backdrop = document.createElement('div');
            backdrop.className = 'edit-modal-backdrop';
            backdrop.innerHTML = `
                <div class="edit-modal-content">
                    <h6>Ù‚Ù… Ø¨ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„ØªÙƒ:</h6>
                    <textarea id="edit-textarea">${currentText}</textarea>
                    <div class="edit-modal-buttons">
                        <button class="btn btn-secondary btn-cancel">Ø¥Ù„ØºØ§Ø¡</button>
                        <button class="btn btn-primary btn-ok">Ø­ÙØ¸</button>
                    </div>
                </div>`;
            document.body.appendChild(backdrop);
            const textarea = document.getElementById('edit-textarea');
            textarea.focus();
            textarea.setSelectionRange(textarea.value.length, textarea.value.length);
            backdrop.querySelector('.btn-ok').onclick = () => {
                const newText = textarea.value;
                if (newText.trim() && newText !== currentText) {
                    updateDoc(doc(db, "messages", id), { text: newText, isEdited: true, lastEditedAt: serverTimestamp() });
                }
                document.body.removeChild(backdrop);
            };
            backdrop.querySelector('.btn-cancel').onclick = () => document.body.removeChild(backdrop);
            backdrop.onclick = (e) => { if (e.target === backdrop) document.body.removeChild(backdrop); };
        }
        window.editMessage = (id, text) => { showEditModal(id, text); };
        
        let touchStartX = 0, touchStartY = 0, touchCurrentX = 0, isSwiping = false, isSwipeLocked = false, swipedElement = null;
        const swipeThreshold = 60, swipeLockThreshold = 10;

        messagesBox.addEventListener('touchstart', (e) => {
            const targetMessage = e.target.closest('.message');
            if (!targetMessage) return;
            touchStartX = e.touches[0].clientX;
            touchStartY = e.touches[0].clientY;
            swipedElement = targetMessage;
        }, { passive: true });

        messagesBox.addEventListener('touchmove', (e) => {
            if (!swipedElement) return;
            touchCurrentX = e.touches[0].clientX;
            const diffX = touchCurrentX - touchStartX;
            const diffY = e.touches[0].clientY - touchStartY;
            if (!isSwipeLocked) {
                if (Math.abs(diffX) > swipeLockThreshold) { isSwiping = true; isSwipeLocked = true; swipedElement.style.transition = 'none'; } 
                else if (Math.abs(diffY) > swipeLockThreshold) { swipedElement = null; isSwipeLocked = true; }
            }
            if (isSwiping && diffX > 0) {
                swipedElement.style.transform = `translateX(${Math.min(diffX, 100)}px)`;
            }
        }, { passive: true });

        messagesBox.addEventListener('touchend', (e) => {
            if (!swipedElement) return;
            if (isSwiping) {
                const diffX = touchCurrentX - touchStartX;
                swipedElement.style.transition = 'transform 0.3s ease';
                if (diffX > swipeThreshold) { setReplyFromElement(swipedElement); }
                swipedElement.style.transform = 'translateX(0)';
            }
            isSwiping = false; isSwipeLocked = false; swipedElement = null;
        });

        window.toggleReaction = async (msgId, emoji) => { if (!auth.currentUser) return; const msgRef = doc(db, "messages", msgId); const msgDoc = await getDoc(msgRef); const msgData = msgDoc.data(); const uid = auth.currentUser.uid; const existing = msgData.reactions?.find(r => r.userId === uid); if (existing) { await updateDoc(msgRef, { reactions: arrayRemove(existing) }); if (existing.emoji !== emoji) { await updateDoc(msgRef, { reactions: arrayUnion({ userId: uid, emoji }) }); } } else { await updateDoc(msgRef, { reactions: arrayUnion({ userId: uid, emoji }) }); } };
        window.deleteOwnMessage = async (id) => { if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ø±Ø³Ø§Ù„ØªÙƒØŸ")) { await deleteDoc(doc(db, "messages", id)); } };
        window.deleteOtherMessage = async (id) => { if (!['developer', 'admin'].includes(currentUserRole)) return; if (confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø±Ø³Ø§Ù„Ø©ØŸ")) { await deleteDoc(doc(db, "messages", id)); } };
        window.banUser = async (uid, name) => { if (!['developer', 'admin'].includes(currentUserRole)) return; const userToBan = await getDoc(doc(db, "users", uid)); if (userToBan.exists() && (userToBan.data().role === 'admin' || userToBan.data().role === 'developer')) { alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø¸Ø± Ù…Ø´Ø±Ù Ø¢Ø®Ø±."); return; } if (confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± ${name}ØŸ`)) { await setDoc(doc(db, "users", uid), { isBanned: true }, { merge: true }); alert(`ØªÙ… Ø­Ø¸Ø± ${name}.`); } };
        
        window.toggleAdminRole = async (uid, name) => {
            if (currentUserRole !== 'developer') return;
            try {
                const userDocRef = doc(db, "users", uid);
                const userDoc = await getDoc(userDocRef);
                const currentRole = userDoc.exists() ? userDoc.data().role || 'user' : 'user';
                const isCurrentlyAdmin = currentRole === 'admin';
                const newRole = isCurrentlyAdmin ? 'user' : 'admin';
                const confirmationMessage = isCurrentlyAdmin ? `Ø¦Û•ØªÛ•ÙˆÛØª ${name} Ù„Ø§ÛŒØ¨Û•ÛŒ Ù„Û•Ø¦Û•Ø¯Ù…ÛŒÙ†ØŸ` : `Ø¦Û•ØªÛ•ÙˆÛØª ${name} Ø¨Ú©Û•ÛŒØªÛ• Ø¦Û•Ø¯Ù…ÛŒÙ†ØŸ`;
                if (confirm(confirmationMessage)) {
                    await setDoc(userDocRef, { role: newRole }, { merge: true });
                    alert(isCurrentlyAdmin ? `ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© ${name} Ù…Ù† Ø§Ù„Ø¥Ø´Ø±Ø§Ù.` : `ØªÙ…Øª ØªØ±Ù‚ÙŠØ© ${name} Ø¥Ù„Ù‰ Ù…Ø´Ø±Ù.`);
                }
            } catch (error) { console.error("Error toggling admin role: ", error); }
        };
    </script>
</body>
</html>
