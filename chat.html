<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>غرفة الدردشة لا أبرح حتى أبلغ بواسطة يوسف الكردي</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://upload-widget.cloudinary.com/global/all.js" type="text/javascript"></script>
    <style>
        :root {
            --primary-color: #00a884;
            --danger-color: #ff5c5c;
            --background-color: #121212;
            --card-background: #1e1e1e;
            --text-color: #FAFAFA;
            --secondary-text-color: #CCCCCC;
            --border-color: #383838;
        }
        html, body {
            height: 100%; margin: 0; padding: 0; overflow: hidden;
        }
        body {
            background-color: var(--background-color); font-family: 'Tajawal', sans-serif;
            color: var(--text-color);
        }
        .chat-wrapper {
            display: flex; justify-content: center; align-items: center; height: 100%;
        }
        .chat-container {
            display: flex; flex-direction: column; height: 100%;
            width: 100%; max-width: 800px; background: #0d1418; /* Custom dark color for chat container */
            box-shadow: 0 0 20px rgba(0,0,0,0.1); border-radius: 0; position: relative;
        }
        @media (min-width: 801px) {
            .chat-container { height: 95vh; border-radius: 15px; }
        }
        .chat-header {
            padding: 1rem;
            background-image: linear-gradient(rgba(0, 0, 0, 0.35), rgba(0, 0, 0, 0.35)), url('https://images.unsplash.com/photo-1433086966358-54859d0ed716?q=80&w=1974&auto=format&fit=crop');
            background-size: cover; background-position: center; border-bottom: 1px solid var(--border-color);
            flex-shrink: 0; color: white;
        }
        .chat-header h5, .chat-header #user-display-name { color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.7); }
        #pinned-message-container, #group-pinned-message-container { 
            padding: 8px 15px; 
            background-color: rgba(255, 251, 230, 0.1); 
            border-bottom: 1px solid #ffe58f; 
            display: none; 
            font-size: 0.9rem; 
            flex-shrink: 0; 
            position: relative; 
        }
        #pinned-message-clickable-area, #group-pinned-message-clickable-area { 
            cursor: pointer; 
            padding-right: 25px; 
        }
        #pinned-by-text, #group-pinned-by-text { 
            font-weight: bold; 
            color: #ffe58f; 
            display: block; 
            font-size: 0.8rem; 
        }
        #pinned-message-text, #group-pinned-message-text { 
            color: #ffe58f; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
            display: block; 
        }
        #unpin-button, #group-unpin-button { 
            position: absolute; 
            top: 50%; 
            right: 10px; 
            transform: translateY(-50%); 
            cursor: pointer; 
            font-size: 1.2rem; 
            color: #ffe58f; 
            z-index: 2; 
        }
        .main-content { flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
        #chat-section { display: flex; flex-direction: column; height: 100%; position: relative; }
        #messages-box {
            flex-grow: 1; overflow-y: auto; padding: 20px;
            background-image: url('https://images.unsplash.com/photo-1500964757637-c85e8a162699?q=80&w=2103&auto=format&fit=crop');
            background-size: cover; background-position: center; user-select: none;
            display: flex; flex-direction: column;
        }
        .message-content { user-select: text; -webkit-user-select: text; }
        .message { margin-bottom: 15px; display: flex; align-items: flex-start; position: relative; padding-bottom: 40px; max-width: 95%; }
        .message.own { align-self: flex-end; flex-direction: row-reverse; }
        .message.other { align-self: flex-start; }
        .avatar { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-left: 10px; flex-shrink: 0; }
        .message.own .avatar { margin-left: 0; margin-right: 10px; }
        .message-bubble { display: flex; flex-direction: column; max-width: calc(100% - 50px); }
        .message-content { padding: 8px 12px; border-radius: 18px; max-width: 100%; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; display: flex; flex-direction: column; }
        .message.own .message-content { background-color: #005c4b; color: white; border-bottom-right-radius: 5px; }
        .message.other .message-content { background-color: #2a3942; color: white; border-bottom-left-radius: 5px; }
        .sender { font-weight: bold; font-size: 0.9rem; margin-bottom: 4px; color: #53bdeb; }
        .timestamp-wrapper { align-self: flex-end; display: flex; align-items: center; margin-top: 4px; margin-left: 15px; }
        .timestamp { font-size: 0.75rem; color: #a0a0a0; }
        .edited-badge { font-size: 0.7rem; color: #a0a0a0; margin-right: 5px; }
        .message-actions { position: absolute; bottom: 5px; z-index: 10; background-color: var(--card-background); padding: 5px 10px; border-radius: 20px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2); font-size: 1rem; display: none; align-items: center; gap: 12px; white-space: nowrap; left: 50%; transform: translateX(-50%); }
        .message:hover .message-actions { display: flex; }
        .message-actions a { cursor: pointer; color: var(--text-color); text-decoration: none; position: relative; }
        .message-actions a:hover { color: #fff; }
        .reply-preview { background-color: #2a3942; padding: 8px 12px; border-bottom: 1px solid #3a4a55; font-size: 0.9rem; display: none; position: relative; flex-shrink: 0; color: var(--text-color); }
        #reply-preview-text, #private-reply-preview-text, #group-reply-preview-text { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .replied-to-box { 
            background-color: #202c33; 
            padding: 8px; 
            margin-bottom: 8px; 
            border-radius: 10px; 
            border-left: 3px solid #53bdeb; 
            font-size: 0.9rem; 
        }
        .reactions-container { position: absolute; top: -35px; background-color: #202c33; border-radius: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.2); display: flex; padding: 5px; opacity: 0; visibility: hidden; transition: all 0.2s; z-index: 10; left: 50%; transform: translateX(-50%); }
        .message-content:hover .reactions-container { opacity: 1; visibility: visible; }
        .reaction-emoji { cursor: pointer; font-size: 1.2rem; margin: 0 4px; transition: transform 0.1s; }
        .reaction-emoji:hover { transform: scale(1.3); }
        .message-reactions { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
        .reaction-chip { background-color: #2a3942; border-radius: 10px; padding: 2px 8px; font-size: 0.8rem; display: flex; align-items: center; }
        .message.own .reaction-chip { background-color: #004a3c; }
        .mute-dropdown { display: none; position: absolute; background-color: #202c33; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; border-radius: 5px; padding: 5px 0; bottom: 100%; }
        .message.own .mute-dropdown { right: 0; }
        .message.other .mute-dropdown { left: 0; }
        .mute-dropdown a { color: white; padding: 8px 12px; text-decoration: none; display: block; font-size: 0.9rem; }
        .mute-dropdown a:hover { background-color: #2a3942; }
        .show-dropdown { display: block; }
        #chat-footer { flex-shrink: 0; }
        #chat-footer .card-footer, #private-chat-footer .card-footer, #group-chat-footer .card-footer { background-color: #1e1e1e; border-top: 1px solid var(--border-color); padding: 10px 15px; }
        #chat-footer .input-group, #private-chat-footer .input-group, #group-chat-footer .input-group { background-color: #2a3942; border-radius: 25px; padding: 5px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        #message-input, #private-message-input, #group-message-input { resize: none; overflow-y: auto; max-height: 120px; border: none; box-shadow: none; background-color: transparent; color: var(--text-color); }
        #send-button, #private-send-button, #group-send-button { background-color: #009688; border-radius: 50%; width: 45px; height: 45px; border: none; display: flex; align-items: center; justify-content: center; }
        #mention-notification { position: absolute; bottom: 15px; right: 20px; width: 40px; height: 40px; background-color: #53bdeb; color: white; border-radius: 50%; display: none; justify-content: center; align-items: center; font-size: 1.5rem; font-weight: bold; cursor: pointer; z-index: 100; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }
        .edit-modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1050; }
        .edit-modal-backdrop.show { display: flex; }
        .edit-modal-content { background-color: #3e4a54; padding: 20px; border-radius: 8px; width: 90%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); color: white; }
        .edit-modal-content textarea { width: 100%; min-height: 100px; background-color: #2a3942; color: white; border: 1px solid #53bdeb; border-radius: 5px; padding: 10px; margin-bottom: 15px; resize: vertical; }
        .edit-modal-buttons { display: flex; justify-content: flex-end; gap: 10px; }
        .card-title { font-weight: 700; color: #FFFFFF; }
        #app-lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(18, 18, 18, 0.95);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .lock-container {
            text-align: center;
            padding: 2rem;
            background-color: var(--card-background);
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }
        .lock-container .icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        #passcode-input {
            max-width: 200px;
            margin: 1.5rem auto;
            letter-spacing: 1.5rem;
            font-size: 1.5rem;
            text-align: center;
            direction: ltr;
        }
        #passcode-input::placeholder {
            letter-spacing: normal;
        }
        #unlock-btn {
            width: 100%;
            max-width: 200px;
        }
        #passcode-error {
            display: none;
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .chat-view {
            display: none;
            flex-direction: column;
            height: 100%;
            width: 100%;
        }
        .chat-view.active {
            display: flex;
        }
        
        #private-messages-box {
             flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
        }
        .tab-content {
            flex-grow: 1;
            position: relative;
        }
        .tab-pane {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-size: cover;
            background-position: center;
            display: flex;
            flex-direction: column;
        }
        #users-list-tab, #groups-tab {
             /* Removed background image to allow container backgrounds to show */
        }
        
        .conversation-list-item {
            display: flex;
            align-items: center;
            padding: 10px;
            cursor: pointer;
            border-radius: 12px;
            transition: background-color 0.2s;
            position: relative;
        }
        .conversation-list-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        .delete-chat-btn {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--danger-color);
            font-size: 1.2rem;
            visibility: hidden;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .conversation-list-item:hover .delete-chat-btn {
            visibility: visible;
            opacity: 0.8;
        }
        
        .avatar-container {
            position: relative;
            display: inline-block;
        }
        .conversation-list-item img {
            width: 55px;
            height: 55px;
            border-radius: 50%;
            object-fit: cover;
            margin-left: 12px;
            border: 2px solid var(--primary-color);
        }
        .notification-dot {
            position: absolute;
            top: 2px;
            right: -2px;
            width: 15px;
            height: 15px;
            background-color: var(--danger-color);
            border-radius: 50%;
            border: 2px solid var(--card-background);
        }
        .unread-badge {
            background-color: var(--primary-color);
            color: white;
            font-size: 0.75rem;
            padding: 0.2em 0.5em;
            border-radius: 50rem;
            margin-inline-start: auto;
        }
        .read-receipt {
            font-size: 1.1rem;
            margin-left: 5px;
        }
        .read-receipt.sent { color: #a0a0a0; }
        .read-receipt.seen { color: #53bdeb; }

        .conversation-info .user-name {
            font-weight: 500;
            font-size: 1rem;
            color: white;
        }
        .conversation-info .last-message {
            font-size: 0.85rem;
            color: white; 
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 200px; 
        }

        #user-search-container {
            padding: 10px;
            flex-shrink: 0;
            border-bottom: 1px solid var(--border-color);
            background-color: rgba(18,18,18,0.3);
        }
        #user-search-input, #group-search-input {
            background-color: rgba(30, 30, 30, 0.8);
            backdrop-filter: blur(5px);
            border: 1px solid var(--border-color);
            color: var(--text-color);
            border-radius: 20px;
            padding: 10px 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            width: 100%;
        }
        #user-search-input::placeholder, #group-search-input::placeholder { color: var(--secondary-text-color); }

        #users-list-container, #my-groups-list-container, #discover-groups-list-container {
            flex-grow: 1;
            overflow-y: auto;
            background-color: rgba(18, 18, 18, 0.6);
            backdrop-filter: blur(5px);
        }
        .user-list-item, .group-list-item {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color);
            transition: background-color 0.2s;
            position: relative; /* Needed for positioning child elements */
        }
        .user-list-item:hover, .group-list-item:hover {
            background-color: rgba(40, 40, 40, 0.8);
        }
        .user-list-item img, .group-list-item img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
            margin-left: 15px;
        }
        .user-list-item .user-name, .group-list-item .group-name {
            font-weight: 500;
        }
        #private-chat-header {
            padding: 1rem;
            background-color: var(--card-background);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        #private-chat-header img {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }
        #private-chat-header h5 {
            margin: 0;
            font-weight: 700;
        }
         #private-messages-box {
            background-image: url('https://images.unsplash.com/photo-1500964757637-c85e8a162699?q=80&w=2103&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .private-message-wrapper {
            margin-bottom: 15px; display: flex; align-items: flex-start; max-width: 95%; position: relative;
        }
        .private-message-wrapper.own { align-self: flex-end; flex-direction: row-reverse; }
        .private-message-wrapper.other { align-self: flex-start; }
        .private-message-wrapper .message-content {
             padding: 8px 12px; border-radius: 18px; max-width: 100%; position: relative; box-shadow: 0 1px 1px rgba(0,0,0,0.1); word-wrap: break-word; display: flex; flex-direction: column;
        }
        .private-message-wrapper.own .message-content { background-color: #005c4b; color: white; border-bottom-right-radius: 5px; }
        .private-message-wrapper.other .message-content { background-color: #2a3942; color: white; border-bottom-left-radius: 5px; }
        
        .private-message-wrapper .message-actions {
            position: absolute;
            bottom: -20px;
            z-index: 10;
            background-color: var(--card-background);
            padding: 5px 10px;
            border-radius: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            font-size: 1rem;
            display: none;
            align-items: center;
            gap: 12px;
            white-space: nowrap;
            left: 50%;
            transform: translateX(-50%);
        }

        .private-message-wrapper:hover .message-actions {
            display: flex;
        }
        
        .private-message-wrapper .message-content:hover .reactions-container {
            opacity: 1;
            visibility: visible;
        }
        .private-message-wrapper .reaction-chip {
             background-color: #2a3942;
        }
        .private-message-wrapper.own .reaction-chip {
            background-color: #004a3c;
        }
        
        #messages-box, #private-messages-box, #group-messages-box {
            position: relative;
            -webkit-overflow-scrolling: touch;
        }

        .swipe-reply-icon-class {
            position: absolute;
            display: none; 
            align-items: center;
            justify-content: center;
            font-size: 1.6rem;
            color: white;
            z-index: 1;
            opacity: 0;
            transition: opacity 0.1s ease, transform 0.1s ease;
            pointer-events: none;
        }

        .message, .private-message-wrapper {
            position: relative; 
            z-index: 2;
            background: transparent; 
            transition: transform 0.2s ease;
            touch-action: pan-y;
        }
        
        /* START: Style for highlighted message */
        .message-highlighted .message-bubble .message-content,
        .private-message-wrapper.message-highlighted .message-content {
            background-color: rgba(83, 189, 235, 0.25) !important;
            transition: background-color 0.5s ease;
            box-shadow: 0 0 15px rgba(83, 189, 235, 0.4);
        }
        /* END: Style for highlighted message */

        /* START: Custom Confirm Modal Styles */
        .confirm-modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            display: none; /* Changed from flex */
            justify-content: center;
            align-items: center;
            z-index: 1060;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s;
        }
        .confirm-modal-backdrop.show {
            display: flex; /* Show when needed */
            opacity: 1;
            visibility: visible;
        }
        .confirm-modal-content {
            background-color: var(--card-background);
            border-radius: 20px;
            padding: 2rem;
            width: 90%;
            max-width: 400px;
            text-align: center;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }
        .confirm-modal-backdrop.show .confirm-modal-content {
            transform: scale(1);
        }
        .confirm-modal-icon {
            font-size: 3.5rem;
            margin-bottom: 1rem;
            color: var(--danger-color);
        }
        .confirm-modal-message {
            font-size: 1.1rem;
            margin-bottom: 2rem;
            color: var(--text-color);
        }
        .confirm-modal-buttons {
            display: flex;
            gap: 1rem;
        }
        .confirm-modal-btn {
            flex: 1;
            padding: 0.8rem;
            border-radius: 12px;
            border: none;
            font-weight: 700;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .confirm-modal-btn:hover {
            opacity: 0.9;
        }
        .btn-confirm-danger {
            background-color: var(--danger-color);
            color: white;
        }
        .btn-confirm-secondary {
            background-color: #4a4a4a;
            color: var(--text-color);
        }
        /* END: Custom Confirm Modal Styles */
        
        /* START: Group Styles */
        .group-list-item .group-info {
            flex-grow: 1;
            overflow: hidden; /* Added to contain children */
        }
        /* START: Accordion styles for group search */
        #group-search-results .group-list-item {
            cursor: pointer;
            align-items: flex-start; /* Align items to top */
        }
        .group-list-item .group-description {
            font-size: 0.85rem;
            color: var(--secondary-text-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: all 0.3s ease-in-out; /* Smooth transition */
        }
        .group-list-item.expanded .group-description {
            white-space: normal;
            overflow: visible;
            text-overflow: clip; /* Or 'initial' */
        }
        .group-actions-container {
            display: none; /* Hidden by default */
            margin-top: 10px;
        }
        .group-list-item.expanded .group-actions-container {
            display: block; /* Shown when expanded */
        }
        /* END: Accordion styles for group search */

        .request-join-btn {
            /* margin-inline-start: auto; no longer needed */
        }
        #group-chat-view {
            background-color: #0d1418;
        }
        #group-chat-header {
            padding: 1rem;
            background-color: var(--card-background);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 15px;
            position: relative;
        }
        #group-chat-header-clickable {
             cursor: pointer;
             display: flex;
             align-items: center;
             gap: 15px;
             flex-grow: 1;
        }
        #group-chat-header-clickable:hover {
            opacity: 0.8;
        }
        #group-avatar-header {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            object-fit: cover;
        }
        #upload-group-photo-container {
            position: absolute;
            left: 60px; /* Adjust based on back button width */
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            gap: 5px;
        }
        #upload-group-photo, #delete-group-photo {
            background-color: rgba(0,0,0,0.5);
            border: none;
            color: white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }
         #group-chat-header h5 {
            margin: 0;
            font-weight: 700;
        }
        #group-messages-box {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            background-image: url('https://images.unsplash.com/photo-1500964757637-c85e8a162699?q=80&w=2103&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        #join-requests-container {
            padding: 10px;
            background-color: #2a3942;
            max-height: 200px;
            overflow-y: auto;
            display: none; /* Hidden by default */
        }
        .join-request-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid var(--border-color);
        }
        .delete-group-btn {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--danger-color);
            font-size: 1.2rem;
            background: none;
            border: none;
            padding: 5px;
            cursor: pointer;
        }
        .group-member-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .group-member-item:last-child {
            border-bottom: none;
        }
        .group-member-item img {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-left: 10px;
        }
        .kick-member-btn, .role-toggle-btn {
            margin-inline-start: 5px;
        }
        .member-actions {
            margin-inline-start: auto;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .role-badge {
            font-size: 0.75rem;
            margin-inline-start: 8px;
        }
        /* END: Group Styles */


    </style>
</head>
<body>
    <div id="app-lock-overlay">
        <div class="lock-container">
            <i class="bi bi-shield-lock-fill icon"></i>
            <h5>التطبيق مقفل</h5>
            <p class="text-secondary small">أدخل رمز المرور للمتابعة</p>
            <input type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" class="form-control" id="passcode-input" placeholder="----">
            <div id="passcode-error">رمز المرور غير صحيح</div>
            <button id="unlock-btn" class="btn btn-primary mt-2">فتح القفل</button>
        </div>
    </div>

    <div class="chat-wrapper">
        <div class="chat-container">

            <!-- START: Main View (Tabs) -->
            <div id="main-view" class="chat-view active">
                <div class="d-flex align-items-center p-1 px-2 border-bottom" style="border-color: var(--border-color) !important;">
                    <div class="flex-grow-1">
                        <ul class="nav nav-pills nav-fill">
                            <li class="nav-item">
                                <a class="nav-link active" data-bs-toggle="pill" href="#group-chat-tab">الدردشة الجماعية</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link position-relative" data-bs-toggle="pill" href="#users-list-tab" id="users-tab-link">
                                    المستخدمون
                                    <span id="private-chat-notification-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="display: none;">
                                    </span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" data-bs-toggle="pill" href="#groups-tab">المجموعات</a>
                            </li>
                        </ul>
                    </div>
                    <a href="./main.html" class="btn text-white fs-4 ms-2"><i class="bi bi-arrow-right"></i></a>
                </div>
                <div class="tab-content flex-grow-1">
                    <div class="tab-pane fade show active h-100" id="group-chat-tab" style="display: flex; flex-direction: column;">
                         <!-- Group chat content is built by JS -->
                    </div>
                    <div class="tab-pane fade h-100" id="users-list-tab">
                         <!-- User list content is built by JS -->
                    </div>
                    <div class="tab-pane fade h-100" id="groups-tab">
                         <!-- Groups tab content is built by JS -->
                    </div>
                </div>
            </div>
            <!-- END: Main View (Tabs) -->

            <!-- START: Private Chat View -->
            <div id="private-chat-view" class="chat-view">
                <div id="private-chat-header">
                     <button id="back-to-main-view" class="btn text-white fs-4"><i class="bi bi-arrow-right"></i></button>
                     <img id="recipient-avatar" src="https://ssl.gstatic.com/images/branding/product/1x/avatar_circle_blue_512dp.png" alt="Avatar">
                    <div class="flex-grow-1">
                        <h5 id="recipient-name">...</h5>
                    </div>
                    <div class="dropdown">
                        <button class="btn text-white fs-5" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-three-dots-vertical"></i>
                        </button>
                        <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end">
                            <li><a class="dropdown-item" href="#" id="block-unblock-btn"></a></li>
                        </ul>
                    </div>
                </div>
                 <div class="main-content">
                    <div id="private-swipe-reply-icon" class="swipe-reply-icon-class"><i class="bi bi-reply-fill"></i></div>
                    <div id="private-messages-box" class="flex-grow-1"></div>
                 </div>
                <div id="private-chat-footer">
                     <div id="private-reply-preview" class="reply-preview">
                        <div id="cancel-private-reply" style="position: absolute; top: 5px; right: 10px; cursor: pointer; font-size: 1.5rem; line-height: 1;">&times;</div>
                        <div class="reply-preview-sender" id="private-reply-preview-sender"></div>
                        <div id="private-reply-preview-text" class="reply-preview-text"></div>
                    </div>
                     <div id="block-notification" class="text-center p-3" style="display: none; background-color: #2a3942; color: var(--secondary-text-color);">
                     </div>
                     <div class="card-footer p-3" id="private-input-area">
                        <div class="input-group">
                            <textarea id="private-message-input" class="form-control" placeholder="اكتب رسالتك..." rows="1"></textarea>
                            <button id="private-send-button" class="btn"><i class="bi bi-send-fill"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END: Private Chat View -->
            
            <!-- START: Group Chat View -->
            <div id="group-chat-view" class="chat-view">
                <div id="group-chat-header">
                     <button id="back-to-main-from-group" class="btn text-white fs-4"><i class="bi bi-arrow-right"></i></button>
                     <div id="group-chat-header-clickable">
                        <img id="group-avatar-header" src="" alt="Group Avatar">
                        <div class="flex-grow-1">
                            <h5 id="group-chat-name">...</h5>
                        </div>
                     </div>
                     <div id="upload-group-photo-container" style="display: none;">
                        <button id="upload-group-photo" class="btn btn-sm" title="تغيير صورة المجموعة"><i class="bi bi-camera-fill"></i></button>
                        <button id="delete-group-photo" class="btn btn-sm" title="حذف صورة المجموعة"><i class="bi bi-trash-fill"></i></button>
                     </div>
                </div>
                 <div id="group-pinned-message-container">
                    <i id="group-unpin-button" class="bi bi-x-circle-fill"></i>
                    <div id="group-pinned-message-clickable-area">
                        <span id="group-pinned-by-text"></span>
                        <span id="group-pinned-message-text"></span>
                    </div>
                </div>
                 <div class="main-content">
                     <div id="group-swipe-reply-icon" class="swipe-reply-icon-class"><i class="bi bi-reply-fill"></i></div>
                     <div id="join-requests-container">
                        <!-- Join requests will be populated here -->
                     </div>
                    <div id="group-messages-box" class="flex-grow-1"></div>
                 </div>
                <div id="group-chat-footer">
                     <div id="group-reply-preview" class="reply-preview">
                        <div id="cancel-group-reply" style="position: absolute; top: 5px; right: 10px; cursor: pointer; font-size: 1.5rem; line-height: 1;">&times;</div>
                        <div class="reply-preview-sender" id="group-reply-preview-sender"></div>
                        <div id="group-reply-preview-text" class="reply-preview-text"></div>
                    </div>
                     <div class="card-footer p-3">
                        <div class="input-group">
                            <textarea id="group-message-input" class="form-control" placeholder="اكتب رسالتك في المجموعة..." rows="1"></textarea>
                            <button id="group-send-button" class="btn"><i class="bi bi-send-fill"></i></button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- END: Group Chat View -->
            
        </div>
    </div>
    
    <!-- START: Create Group Modal -->
    <div class="modal fade" id="create-group-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">إنشاء مجموعة جديدة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="create-group-form">
                        <div class="mb-3">
                            <label for="group-name-input" class="form-label">اسم المجموعة</label>
                            <input type="text" class="form-control" id="group-name-input" required>
                        </div>
                        <div class="mb-3">
                            <label for="group-description-input" class="form-label">وصف قصير</label>
                            <input type="text" class="form-control" id="group-description-input">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">إنشاء</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- END: Create Group Modal -->

    <!-- START: Group Members Modal -->
    <div class="modal fade" id="group-members-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">أعضاء المجموعة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0" id="group-members-list">
                    <!-- Members will be populated here by JS -->
                </div>
                <div class="modal-footer border-secondary flex-column" id="group-members-modal-footer">
                    <!-- Footer content will be injected here by JS -->
                </div>
            </div>
        </div>
    </div>
    <!-- END: Group Members Modal -->

    <!-- START: Edit Group Description Modal -->
    <div class="modal fade" id="edit-group-description-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content bg-dark text-white">
                <div class="modal-header border-secondary">
                    <h5 class="modal-title">تعديل وصف المجموعة</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="edit-group-description-form">
                        <div class="mb-3">
                            <textarea class="form-control" id="group-description-textarea" rows="4"></textarea>
                        </div>
                        <button type="submit" class="btn btn-primary w-100">حفظ التغييرات</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- END: Edit Group Description Modal -->

    <!-- START: Edit Message Modal -->
    <div class="edit-modal-backdrop" id="edit-message-modal">
        <div class="edit-modal-content">
            <h6>قم بتعديل رسالتك:</h6>
            <textarea id="edit-message-textarea"></textarea>
            <div class="edit-modal-buttons">
                <button id="cancel-edit-btn" class="btn btn-secondary">إلغاء</button>
                <button id="save-edit-btn" class="btn btn-primary">حفظ</button>
            </div>
        </div>
    </div>
    <!-- END: Edit Message Modal -->
    
    <!-- START: Custom Confirm Modal HTML -->
    <div class="confirm-modal-backdrop" id="custom-confirm-modal">
        <div class="confirm-modal-content">
            <div class="confirm-modal-icon"><i class="bi bi-exclamation-triangle-fill"></i></div>
            <p class="confirm-modal-message" id="custom-confirm-message"></p>
            <div class="confirm-modal-buttons">
                <button class="confirm-modal-btn btn-confirm-secondary" id="custom-confirm-cancel">إلغاء</button>
                <button class="confirm-modal-btn btn-confirm-danger" id="custom-confirm-ok">تأكيد</button>
            </div>
        </div>
    </div>
    <!-- END: Custom Confirm Modal HTML -->

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        // This script runs before the main module script below.
        if (!sessionStorage.getItem('sessionStarted')) {
            sessionStorage.setItem('sessionStarted', 'true');
            if (window.location.pathname.includes('chat.html')) {
                 window.location.replace('./main.html');
            }
        }
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc, getDocs, deleteDoc, setDoc, updateDoc, arrayUnion, arrayRemove, where, limit, increment, writeBatch, deleteField } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAGgZmhJ_mMezlf7xElisvzJ8l9D758d4g",
            authDomain: "my-chat-app-daaf8.firebaseapp.com",
            projectId: "my-chat-app-daaf8",
            storageBucket: "my-chat-app-daaf8.firebasestorage.app",
            messagingSenderId: "789086064752",
            appId: "1:789086064752:web:d081f1b6832dabca1d64b5"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- View References ---
        const mainView = document.getElementById('main-view');
        const privateChatView = document.getElementById('private-chat-view');
        const groupChatView = document.getElementById('group-chat-view');
        
        // --- Tab Content References ---
        const groupChatTab = document.getElementById('group-chat-tab');
        const usersListTab = document.getElementById('users-list-tab');
        const groupsTab = document.getElementById('groups-tab');
        
        // --- Group chat Tab ---
        const originalChatStructure = document.createElement('div');
        originalChatStructure.style.display = 'flex';
        originalChatStructure.style.flexDirection = 'column';
        originalChatStructure.style.height = '100%';
        originalChatStructure.innerHTML = `
            <div id="pinned-message-container">
                 <i id="unpin-button" class="bi bi-x-circle-fill"></i>
                <div id="pinned-message-clickable-area">
                    <span id="pinned-by-text"></span>
                    <span id="pinned-message-text"></span>
                </div>
            </div>
            <div class="main-content">
                <div id="chat-section">
                    <div id="swipe-reply-icon" class="swipe-reply-icon-class"><i class="bi bi-reply-fill"></i></div>
                    <div id="messages-box"></div>
                    <div id="mention-notification">@</div>
                </div>
            </div>
            <div id="chat-footer">
                <div id="reply-preview" class="reply-preview">
                    <div id="cancel-reply" style="position: absolute; top: 5px; right: 10px; cursor: pointer; font-size: 1.5rem; line-height: 1;">&times;</div>
                    <div class="reply-preview-sender" id="reply-preview-sender"></div>
                    <div id="reply-preview-text" class="reply-preview-text"></div>
                </div>
                <div class="card-footer p-3">
                    <div class="input-group">
                        <textarea id="message-input" class="form-control" placeholder="اكتب رسالتك..." rows="1"></textarea>
                        <button id="send-button" class="btn"><i class="bi bi-send-fill"></i></button>
                    </div>
                </div>
            </div>
        `;
        groupChatTab.appendChild(originalChatStructure);
        
        // --- Users Tab ---
        usersListTab.innerHTML = `
            <div style="display: flex; flex-direction: column; height: 100%;">
                <div id="user-search-container">
                    <input type="search" id="user-search-input" class="form-control" placeholder="ابحث عن مستخدم...">
                </div>
                <div id="users-list-container" class="flex-grow-1">
                     <h6 class="text-muted p-2 mt-2" id="conversation-list-title">المحادثات</h6>
                    <div id="conversation-list">
                         <p class="text-center text-muted p-3">لا توجد محادثات خاصة بعد</p>
                    </div>
                </div>
            </div>
        `;

        // --- Groups Tab ---
        groupsTab.innerHTML = `
            <div style="display: flex; flex-direction: column; height: 100%;">
                <div class="p-2 flex-shrink: 0;">
                    <button class="btn btn-primary w-100" data-bs-toggle="modal" data-bs-target="#create-group-modal">
                        <i class="bi bi-plus-circle-fill me-2"></i> إنشاء مجموعة جديدة
                    </button>
                </div>
                
                <!-- My Groups Section -->
                <div id="my-groups-list-container" class="flex-grow-1" style="overflow-y: auto; display: flex; flex-direction: column; min-height: 40%;">
                    <h6 class="text-white p-2 flex-shrink: 0;">مجموعاتي</h6>
                    <div id="my-groups-list" class="flex-grow-1">
                        <!-- My groups will be populated here -->
                    </div>
                </div>
                
                <!-- Divider -->
                <hr class="my-1" style="border-color: var(--border-color);">

                <!-- Discover Groups Section -->
                <div id="discover-groups-list-container" class="flex-grow-1" style="overflow-y: auto; display: flex; flex-direction: column;">
                    <h6 class="text-white p-2 flex-shrink: 0;">اكتشف مجموعات</h6>
                    <div id="discover-groups-list" class="flex-grow-1">
                        <!-- Discoverable groups will be populated here -->
                    </div>
                </div>
            </div>
        `;

        // General UI References
        const userDisplayName = document.getElementById('user-display-name');
        const messagesBox = document.getElementById('messages-box');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const replyPreview = document.getElementById('reply-preview');
        const cancelReplyButton = document.getElementById('cancel-reply');
        const mentionNotification = document.getElementById('mention-notification');
        const pinnedMessageContainer = document.getElementById('pinned-message-container');
        const pinnedByText = document.getElementById('pinned-by-text');
        const pinnedMessageText = document.getElementById('pinned-message-text');
        const unpinButton = document.getElementById('unpin-button');
        const pinnedMessageClickableArea = document.getElementById('pinned-message-clickable-area');
        
        // Private Chat References
        const usersListContainer = document.getElementById('users-list-container').querySelector('#conversation-list');
        const userSearchInput = document.getElementById('user-search-input');
        const backToMainViewBtn = document.getElementById('back-to-main-view');
        const recipientNameEl = document.getElementById('recipient-name');
        const recipientAvatarEl = document.getElementById('recipient-avatar');
        const privateMessagesBox = document.getElementById('private-messages-box');
        const privateMessageInput = document.getElementById('private-message-input');
        const privateSendButton = document.getElementById('private-send-button');
        const blockUnblockBtn = document.getElementById('block-unblock-btn');

        // Group System References
        const createGroupForm = document.getElementById('create-group-form');
        const createGroupModal = new bootstrap.Modal(document.getElementById('create-group-modal'));
        const groupMembersModalEl = document.getElementById('group-members-modal');
        const groupMembersModal = new bootstrap.Modal(groupMembersModalEl);
        // const myGroupsList = document.getElementById('my-groups-list');
        // const myGroupsTitle = document.getElementById('my-groups-title');
        // const groupSearchInput = document.getElementById('group-search-input');
        // const groupSearchResults = document.getElementById('group-search-results');
        const backToMainFromGroupBtn = document.getElementById('back-to-main-from-group');
        const groupChatHeaderClickable = document.getElementById('group-chat-header-clickable');
        const groupAvatarHeader = document.getElementById('group-avatar-header');
        const uploadGroupPhotoContainer = document.getElementById('upload-group-photo-container');
        const uploadGroupPhotoBtn = document.getElementById('upload-group-photo');
        const deleteGroupPhotoBtn = document.getElementById('delete-group-photo');
        const groupChatNameEl = document.getElementById('group-chat-name');
        const groupMessagesBox = document.getElementById('group-messages-box');
        const groupMessageInput = document.getElementById('group-message-input');
        const groupSendButton = document.getElementById('group-send-button');
        const joinRequestsContainer = document.getElementById('join-requests-container');
        const groupReplyPreview = document.getElementById('group-reply-preview');
        const cancelGroupReplyBtn = document.getElementById('cancel-group-reply');
        const groupPinnedMessageContainer = document.getElementById('group-pinned-message-container');
        const groupPinnedByText = document.getElementById('group-pinned-by-text');
        const groupPinnedMessageText = document.getElementById('group-pinned-message-text');
        const groupUnpinButton = document.getElementById('group-unpin-button');
        const groupPinnedMessageClickableArea = document.getElementById('group-pinned-message-clickable-area');

        // Edit Modal References
        const editMessageModalEl = document.getElementById('edit-message-modal');
        const editMessageTextarea = document.getElementById('edit-message-textarea');
        const saveEditBtn = document.getElementById('save-edit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const editGroupDescriptionModalEl = document.getElementById('edit-group-description-modal');
        const editGroupDescriptionModal = new bootstrap.Modal(editGroupDescriptionModalEl);
        const editGroupDescriptionForm = document.getElementById('edit-group-description-form');

        // App Lock References
        const appLockOverlay = document.getElementById('app-lock-overlay');
        const passcodeError = document.getElementById('passcode-error');
        const unlockBtn = document.getElementById('unlock-btn');
        const passcodeInput = document.getElementById('passcode-input');
        
        // --- State Variables ---
        let currentUserRole = 'user';
        let currentDisplayName = 'زائر';
        let replyToMessage = null;
        let privateReplyToMessage = null; 
        let groupReplyToMessage = null;
        let editingMessageInfo = null;
        const userProfiles = {};
        let isVisitor = true;
        let unreadCount = 0;
        let originalFavicon = document.querySelector("link[rel*='icon']")?.href || '/favicon.ico';
        const originalTitle = document.title;
        let currentUserId = null;
        let recipientId = null;
        let privateChatRoomId = null;
        let currentGroupId = null;
        let currentGroupData = null; // To store current group info
        
        let unsubscribePrivateChat = null;
        let unsubscribeConversations = null;
        let unsubscribeUserProfiles = null; 
        let unsubscribeUserDoc = null; 
        let unsubscribeRecipientDoc = null;
        let unsubscribeMyGroups = null;
        let unsubscribeGroupDoc = null;
        let unsubscribeGroupMessages = null;
        let unsubscribeJoinRequests = null;

        const RELOCK_TIME = 3 * 60 * 1000;
        
        // --- START: Custom Confirm Modal Logic ---
        const confirmModalEl = document.getElementById('custom-confirm-modal');
        const confirmMessageEl = document.getElementById('custom-confirm-message');
        const confirmIconEl = confirmModalEl.querySelector('.confirm-modal-icon i');
        const confirmOkBtn = document.getElementById('custom-confirm-ok');
        const confirmCancelBtn = document.getElementById('custom-confirm-cancel');
        let confirmCallback = null;

        function showCustomConfirm(message, iconClass, onConfirm) {
            confirmMessageEl.textContent = message;
            confirmIconEl.className = iconClass;
            confirmCallback = onConfirm;
            confirmModalEl.classList.add('show');
        }
        
        confirmCancelBtn.addEventListener('click', () => {
            confirmModalEl.classList.remove('show');
            confirmCallback = null;
        });

        confirmOkBtn.addEventListener('click', () => {
            if (confirmCallback) {
                confirmCallback();
            }
            confirmModalEl.classList.remove('show');
            confirmCallback = null;
        });
        // --- END: Custom Confirm Modal Logic ---
        
        // --- START: View Management ---
        function showMainView() {
            mainView.classList.add('active');
            privateChatView.classList.remove('active');
            groupChatView.classList.remove('active');
            
            recipientId = null;
            privateChatRoomId = null;
            currentGroupId = null;
            currentGroupData = null;
            
            groupChatHeaderClickable.onclick = null; // Clear click listener

            if (unsubscribePrivateChat) { unsubscribePrivateChat(); unsubscribePrivateChat = null; }
            if (unsubscribeUserDoc) { unsubscribeUserDoc(); unsubscribeUserDoc = null; }
            if (unsubscribeRecipientDoc) { unsubscribeRecipientDoc(); unsubscribeRecipientDoc = null; }
            if (unsubscribeGroupMessages) { unsubscribeGroupMessages(); unsubscribeGroupMessages = null; }
            if (unsubscribeJoinRequests) { unsubscribeJoinRequests(); unsubscribeJoinRequests = null; }
            if (unsubscribeGroupDoc) { unsubscribeGroupDoc(); unsubscribeGroupDoc = null; }
        }

        async function showPrivateChatView(targetUserId, targetUserName, targetUserAvatar) {
            recipientId = targetUserId;
            if (!currentUserId || !recipientId) return;

            privateChatRoomId = [currentUserId, recipientId].sort().join('_');

            const chatRoomRefForUnread = doc(db, "private_chats", privateChatRoomId);
            await updateDoc(chatRoomRefForUnread, { [`unread_count_${currentUserId}`]: 0 }).catch(console.error);
            
            if (unsubscribeUserDoc) unsubscribeUserDoc();
            if (unsubscribeRecipientDoc) unsubscribeRecipientDoc();

            const updateBlockStatusUI = async () => {
                const userDocSnap = await getDoc(doc(db, "users", currentUserId));
                const recipientDocSnap = await getDoc(doc(db, "users", recipientId));

                if (!userDocSnap.exists()) return;
                const currentUserData = userDocSnap.data();
                const recipientData = recipientDocSnap.exists() ? recipientDocSnap.data() : {};
                
                const iAmBlocked = recipientData.blockedUsers?.includes(currentUserId);
                const iHaveBlocked = currentUserData.blockedUsers?.includes(recipientId);

                const privateInputArea = document.getElementById('private-input-area');
                const blockNotification = document.getElementById('block-notification');

                if (iAmBlocked) {
                    blockNotification.textContent = 'لا يمكنك إرسال رسالة إلى هذا المستخدم لأنه قام بحظرك.';
                    blockNotification.style.display = 'block';
                    privateInputArea.style.display = 'none';
                } else if (iHaveBlocked) {
                    blockNotification.textContent = `لقد قمت بحظر هذا المستخدم.`;
                    blockNotification.style.display = 'block';
                    privateInputArea.style.display = 'none';
                } else {
                    blockNotification.style.display = 'none';
                    privateInputArea.style.display = 'block';
                }

                if(iHaveBlocked) {
                    blockUnblockBtn.innerHTML = `<i class="bi bi-unlock-fill text-success me-2"></i> إلغاء الحظر`;
                    blockUnblockBtn.onclick = () => toggleBlockUser(false);
                } else {
                    blockUnblockBtn.innerHTML = `<i class="bi bi-slash-circle-fill text-danger me-2"></i> حظر المستخدم`;
                    blockUnblockBtn.onclick = () => toggleBlockUser(true);
                }
            };
            
            unsubscribeUserDoc = onSnapshot(doc(db, "users", currentUserId), updateBlockStatusUI);
            unsubscribeRecipientDoc = onSnapshot(doc(db, "users", recipientId), updateBlockStatusUI);
            
            const chatRoomRef = doc(db, "private_chats", privateChatRoomId);
            const chatRoomSnap = await getDoc(chatRoomRef);
            if (!chatRoomSnap.exists()) {
                await setDoc(chatRoomRef, {
                    participants: [currentUserId, recipientId],
                    lastMessageTimestamp: serverTimestamp(),
                    [`unread_count_${currentUserId}`]: 0,
                    [`unread_count_${recipientId}`]: 0,
                    [`hidden_for_${currentUserId}`]: false,
                    [`hidden_for_${recipientId}`]: false
                }, { merge: true });
            }

            recipientNameEl.textContent = targetUserName;
            recipientAvatarEl.src = targetUserAvatar || 'https://ssl.gstatic.com/images/branding/product/1x/avatar_circle_blue_512dp.png';
            mainView.classList.remove('active');
            privateChatView.classList.add('active');
            groupChatView.classList.remove('active');
            loadPrivateMessages();
        }
        
        async function showGroupChatView(groupId, groupName) {
            const groupDocRef = doc(db, "groups", groupId);
            const groupDocSnap = await getDoc(groupDocRef);
            if (!groupDocSnap.exists()) {
                showCustomConfirm("المجموعة غير موجودة.", "bi bi-exclamation-circle-fill", () => {});
                return;
            }
            
            currentGroupData = groupDocSnap.data();
            let isMember = currentGroupData.members && currentGroupData.members[currentUserId];

            // Developer auto-join logic remains for convenience
            if (currentUserRole === 'developer' && !isMember) {
                await updateDoc(groupDocRef, { [`members.${currentUserId}`]: 'member' });
                const updatedGroupSnap = await getDoc(groupDocRef);
                currentGroupData = updatedGroupSnap.data();
                isMember = true;
            }
            
            const groupChatFooter = document.getElementById('group-chat-footer');

            if (isMember) {
                // Behavior for group members (original logic)
                groupChatFooter.innerHTML = `
                     <div id="group-reply-preview" class="reply-preview">
                        <div id="cancel-group-reply" style="position: absolute; top: 5px; right: 10px; cursor: pointer; font-size: 1.5rem; line-height: 1;">&times;</div>
                        <div class="reply-preview-sender" id="group-reply-preview-sender"></div>
                        <div id="group-reply-preview-text" class="reply-preview-text"></div>
                    </div>
                     <div class="card-footer p-3">
                        <div class="input-group">
                            <textarea id="group-message-input" class="form-control" placeholder="اكتب رسالتك في المجموعة..." rows="1"></textarea>
                            <button id="group-send-button" class="btn"><i class="bi bi-send-fill"></i></button>
                        </div>
                    </div>
                `;
                document.getElementById('group-send-button').addEventListener('click', sendGroupMessage);
                const groupMessageInputNew = document.getElementById('group-message-input');
                groupMessageInputNew.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendGroupMessage(); } });
                groupMessageInputNew.addEventListener('input', () => { groupMessageInputNew.style.height = 'auto'; groupMessageInputNew.style.height = (groupMessageInputNew.scrollHeight) + 'px'; });
                document.getElementById('cancel-group-reply').addEventListener('click', cancelGroupReply);

                currentGroupId = groupId;
                groupChatNameEl.textContent = groupName;
                groupAvatarHeader.src = currentGroupData.groupPhotoURL || `https://placehold.co/100x100/00a884/FFFFFF?text=${groupName.charAt(0)}`;
                
                const currentUserRoleInGroup = currentGroupData.members[currentUserId];
                if (currentGroupData.ownerId === currentUserId) {
                    uploadGroupPhotoContainer.style.display = 'flex';
                    uploadGroupPhotoBtn.onclick = () => uploadGroupPhoto(groupId);
                    deleteGroupPhotoBtn.style.display = currentGroupData.groupPhotoURL ? 'flex' : 'none';
                    deleteGroupPhotoBtn.onclick = () => deleteGroupPhoto(groupId);
                } else {
                    uploadGroupPhotoContainer.style.display = 'none';
                }
                if (currentUserRoleInGroup === 'owner' || currentUserRoleInGroup === 'admin') {
                    joinRequestsContainer.style.display = 'block';
                    loadJoinRequests(groupId);
                } else {
                    joinRequestsContainer.style.display = 'none';
                }
                groupChatHeaderClickable.onclick = () => showGroupMembers(groupId);
                loadGroupPinnedMessage(groupId);
                loadGroupMessages(groupId);

            } else {
                // Behavior for non-members (new logic)
                currentGroupId = groupId;
                groupChatNameEl.textContent = groupName;
                groupAvatarHeader.src = currentGroupData.groupPhotoURL || `https://placehold.co/100x100/00a884/FFFFFF?text=${groupName.charAt(0)}`;
                
                groupMessagesBox.innerHTML = `
                    <div class="text-center p-5 text-muted d-flex flex-column justify-content-center align-items-center h-100">
                        <i class="bi bi-people-fill" style="font-size: 4rem;"></i>
                        <h4 class="mt-3">${groupName}</h4>
                        <p class="lead">${currentGroupData.description || 'انضم إلى هذه المجموعة لعرض الرسائل والدردشة.'}</p>
                    </div>
                `;

                groupChatFooter.innerHTML = `
                    <div class="card-footer p-3">
                        <button id="request-to-join-from-view-btn" class="btn btn-success w-100">
                            <i class="bi bi-person-plus-fill me-2"></i> طلب انضمام
                        </button>
                    </div>
                `;
                
                document.getElementById('request-to-join-from-view-btn').addEventListener('click', (e) => {
                    if (isVisitor) {
                         showCustomConfirm("يجب عليك تسجيل الدخول أولاً لإرسال طلب انضمام.", "bi bi-box-arrow-in-right", () => {
                             window.location.href = 'index.html';
                        });
                        return;
                    }
                    window.requestToJoinGroup(groupId, e.currentTarget);
                });

                uploadGroupPhotoContainer.style.display = 'none';
                joinRequestsContainer.style.display = 'none';
                groupPinnedMessageContainer.style.display = 'none';
                groupChatHeaderClickable.onclick = null;
                if (unsubscribeGroupMessages) { unsubscribeGroupMessages(); unsubscribeGroupMessages = null; }
                if (unsubscribeGroupDoc) { unsubscribeGroupDoc(); unsubscribeGroupDoc = null; }
                if (unsubscribeJoinRequests) { unsubscribeJoinRequests(); unsubscribeJoinRequests = null; }
            }
            
            mainView.classList.remove('active');
            privateChatView.classList.remove('active');
            groupChatView.classList.add('active');
        }
        window.showGroupChatView = showGroupChatView;


        backToMainViewBtn.addEventListener('click', showMainView);
        backToMainFromGroupBtn.addEventListener('click', showMainView);
        // --- END: View Management ---

        onAuthStateChanged(auth, async user => {
            initializeAppLock();
            setInterval(() => { if (document.visibilityState === 'visible') localStorage.setItem('app_last_unlock', Date.now()); }, 60 * 1000);
            document.addEventListener('visibilitychange', () => { if (document.visibilityState === 'visible') initializeAppLock(); });

            if (user) {
                // User is signed in.
                localStorage.setItem('lastReadTimestamp', Date.now().toString());
                currentUserId = user.uid;
                
                const userDocRef = doc(db, "users", user.uid);
                const userDocSnap = await getDoc(userDocRef);
                
                // If user doc doesn't exist and they are not anonymous, they are a new user who shouldn't be here.
                if (!userDocSnap.exists() && !user.isAnonymous) {
                     window.location.href = 'index.html';
                     return;
                }

                const userData = userDocSnap.exists() ? userDocSnap.data() : {};
                
                // Set global user state
                currentDisplayName = userData.displayName || `زائر-${user.uid.substring(0, 5)}`;
                currentUserRole = userData.role || 'user';
                isVisitor = user.isAnonymous || !userData.displayName;

                if (isVisitor && !userData.displayName) {
                    await setDoc(userDocRef, { displayName: currentDisplayName, isVisitor: true, role: 'user' }, { merge: true });
                }
                
                userProfiles[user.uid] = { ...userData, displayName: currentDisplayName, role: currentUserRole, isVisitor };
                
                listenForUserProfiles(); 
                loadMessages();
                loadPinnedMessage();
                listenForMyGroups();
                
                initializeSwipeToReply('messages-box', '.message', setReplyFromElement);
                initializeSwipeToReply('private-messages-box', '.private-message-wrapper', setPrivateReplyFromElement);
                initializeSwipeToReply('group-messages-box', '.message', setGroupReplyFromElement);

            } else {
                // No user is signed in. Redirect to login page.
                window.location.href = 'index.html';
            }
        });

        function initializeSwipeToReply(containerId, messageSelector, replyFunction) {
            const container = document.getElementById(containerId);
            if (!container) return;
            // The public chat doesn't have its own swipe icon, it's inside the main content.
            const swipeIcon = containerId === 'messages-box'
                ? document.getElementById('swipe-reply-icon')
                : container.parentElement.querySelector('.swipe-reply-icon-class');
            
            if (!swipeIcon) {
                console.warn(`Swipe icon not found for container ${containerId}`);
                return;
            }

            let startX = 0, startY = 0, currentX = 0, swipedElement = null, isScrolling = false, isSwipeGesture = false;
            const SWIPE_THRESHOLD = 80, DIRECTION_LOCK_THRESHOLD = 10;
            container.addEventListener('touchstart', (e) => {
                if (e.target.closest('a, button, .message-actions, .reactions-container') || container.isScrolling) { swipedElement = null; return; }
                const targetMessage = e.target.closest(messageSelector); if (!targetMessage) return;
                swipedElement = targetMessage; startX = e.touches[0].clientX; startY = e.touches[0].clientY; currentX = startX;
                isScrolling = false; isSwipeGesture = false; swipedElement.style.transition = 'none';
            }, { passive: true });
            let scrollTimeout;
            container.addEventListener('scroll', () => { container.isScrolling = true; clearTimeout(scrollTimeout); scrollTimeout = setTimeout(() => { container.isScrolling = false; }, 150); });
            container.addEventListener('touchmove', (e) => {
                if (!swipedElement || isScrolling) return;
                currentX = e.touches[0].clientX; const currentY = e.touches[0].clientY; const deltaX = currentX - startX; const deltaY = currentY - startY;
                if (!isSwipeGesture) {
                    if (Math.abs(deltaY) > DIRECTION_LOCK_THRESHOLD && Math.abs(deltaY) > Math.abs(deltaX)) { isScrolling = true; swipedElement = null; return; } 
                    else if (Math.abs(deltaX) > DIRECTION_LOCK_THRESHOLD) { isSwipeGesture = true; swipeIcon.style.top = `${swipedElement.offsetTop + (swipedElement.offsetHeight / 2) - 20}px`; swipeIcon.style.left = '20px'; swipeIcon.style.display = 'flex'; swipeIcon.style.opacity = '0'; }
                }
                if (isSwipeGesture) {
                    e.preventDefault(); const swipeDistance = Math.max(0, deltaX); const constrainedDistance = Math.min(swipeDistance, 120);
                    swipedElement.style.transform = `translateX(${constrainedDistance}px)`; const iconOpacity = Math.min(constrainedDistance / SWIPE_THRESHOLD, 1);
                    swipeIcon.style.opacity = iconOpacity; swipeIcon.style.transform = `scale(${0.8 + iconOpacity * 0.2})`;
                }
            }, { passive: false });
            container.addEventListener('touchend', (e) => {
                if (!swipedElement) return;
                if (isSwipeGesture) { const deltaX = currentX - startX; if (deltaX > SWIPE_THRESHOLD) { replyFunction(swipedElement); } }
                swipedElement.style.transition = 'transform 0.2s ease'; swipedElement.style.transform = 'translateX(0px)';
                if (swipeIcon) { swipeIcon.style.opacity = '0'; setTimeout(() => { if (swipeIcon.style.opacity === '0') swipeIcon.style.display = 'none'; }, 200); }
                swipedElement = null; isSwipeGesture = false;
            });
        }
        
        // --- START: Group System Logic ---
        createGroupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const groupName = document.getElementById('group-name-input').value.trim();
            const description = document.getElementById('group-description-input').value.trim();
            
            if (!groupName || !currentUserId) return;
            
            try {
                await addDoc(collection(db, "groups"), {
                    groupName,
                    description,
                    ownerId: currentUserId,
                    members: {
                        [currentUserId]: "owner"
                    },
                    groupPhotoURL: null,
                    createdAt: serverTimestamp()
                });
                createGroupForm.reset();
                createGroupModal.hide();
            } catch (error) {
                console.error("Error creating group:", error);
                showCustomConfirm("حدث خطأ أثناء إنشاء المجموعة.", "bi bi-exclamation-triangle-fill", () => {});
            }
        });

        function listenForMyGroups() {
            if (unsubscribeMyGroups) unsubscribeMyGroups();
            
            const myGroupsList = document.getElementById('my-groups-list');
            const discoverGroupsList = document.getElementById('discover-groups-list');

            const q = query(collection(db, "groups"), orderBy("createdAt", "desc"));
            
            unsubscribeMyGroups = onSnapshot(q, (snapshot) => {
                const myGroups = [];
                const otherGroups = [];

                snapshot.forEach(doc => {
                    const groupData = { id: doc.id, ...doc.data() };
                    if (groupData.members && groupData.members[currentUserId]) {
                        myGroups.push(groupData);
                    } else {
                        otherGroups.push(groupData);
                    }
                });

                // --- Render My Groups ---
                if (!myGroupsList) return;
                if (myGroups.length === 0) {
                    myGroupsList.innerHTML = '<p class="text-center text-muted p-3">أنت لست عضواً في أي مجموعة بعد</p>';
                } else {
                    myGroupsList.innerHTML = '';
                    myGroups.forEach(group => {
                        const escapedGroupName = group.groupName.replace(/'/g, "\\'");
                        let deleteBtnHtml = '';
                        if (currentUserRole === 'developer' || group.ownerId === currentUserId) {
                            deleteBtnHtml = `<button class="delete-group-btn" onclick="event.stopPropagation(); window.deleteGroup('${group.id}', '${escapedGroupName}')"><i class="bi bi-trash-fill"></i></button>`;
                        }

                        const groupEl = document.createElement('div');
                        groupEl.className = 'group-list-item';
                        const groupPhoto = group.groupPhotoURL || `https://placehold.co/100x100/00a884/FFFFFF?text=${group.groupName.charAt(0)}`;
                        
                        groupEl.innerHTML = `
                            <img src="${groupPhoto}" alt="Group Icon">
                            <div class="group-info">
                                <div class="group-name">${group.groupName}</div>
                                <div class="group-description">${group.description || 'لا يوجد وصف'}</div>
                            </div>
                            ${deleteBtnHtml}
                        `;
                        groupEl.addEventListener('click', () => showGroupChatView(group.id, group.groupName));
                        myGroupsList.appendChild(groupEl);
                    });
                }

                // --- Render Discover Groups ---
                if (!discoverGroupsList) return;
                if (otherGroups.length === 0) {
                    discoverGroupsList.innerHTML = '<p class="text-center text-muted p-3">لا توجد مجموعات أخرى لاكتشافها</p>';
                } else {
                    discoverGroupsList.innerHTML = '';
                    otherGroups.forEach(group => {
                        const escapedGroupName = group.groupName.replace(/'/g, "\\'");
                        let deleteBtnHtml = '';
                        if (currentUserRole === 'developer') {
                            deleteBtnHtml = `<button class="delete-group-btn" onclick="event.stopPropagation(); window.deleteGroup('${group.id}', '${escapedGroupName}')"><i class="bi bi-trash-fill"></i></button>`;
                        }

                        const groupEl = document.createElement('div');
                        groupEl.className = 'group-list-item';
                        const groupPhoto = group.groupPhotoURL || `https://placehold.co/100x100/00a884/FFFFFF?text=${group.groupName.charAt(0)}`;
                        
                        groupEl.innerHTML = `
                            <img src="${groupPhoto}" alt="Group Icon">
                            <div class="group-info">
                                <div class="group-name">${group.groupName}</div>
                                <div class="group-description">${group.description || 'لا يوجد وصف'}</div>
                            </div>
                            ${deleteBtnHtml}
                        `;
                        groupEl.addEventListener('click', () => showGroupChatView(group.id, group.groupName));
                        discoverGroupsList.appendChild(groupEl);
                    });
                }

            }, (error) => {
                console.error("Error listening for all groups:", error);
            });
        }
        
        window.deleteGroup = async (groupId, groupName) => {
            showCustomConfirm(
                `هل أنت متأكد من حذف مجموعة "${groupName}"؟ لا يمكن التراجع عن هذا الإجراء.`,
                "bi bi-trash3-fill",
                async () => {
                    await deleteDoc(doc(db, "groups", groupId));
                }
            );
        };
        
        async function showGroupMembers(groupId) {
            const groupRef = doc(db, "groups", groupId);
            const groupSnap = await getDoc(groupRef);

            if (!groupSnap.exists()) return;

            const groupData = groupSnap.data();
            const currentUserRoleInGroup = groupData.members[currentUserId];
            const membersListEl = document.getElementById('group-members-list');
            const membersModalFooter = document.getElementById('group-members-modal-footer');
            membersListEl.innerHTML = '';
            membersModalFooter.innerHTML = '';

            // --- START: NEW FEATURE - Leave Group Button ---
            if (currentUserRoleInGroup && currentUserRoleInGroup !== 'owner') {
                 const leaveBtn = document.createElement('button');
                 leaveBtn.className = 'btn btn-danger w-100 mb-2'; // Added margin bottom
                 leaveBtn.innerHTML = '<i class="bi bi-box-arrow-right me-2"></i> مغادرة المجموعة';
                 const escapedGroupName = groupData.groupName.replace(/'/g, "\\'");
                 leaveBtn.onclick = () => window.leaveCurrentGroup(groupId, escapedGroupName);
                 membersModalFooter.appendChild(leaveBtn);
            }
            // --- END: NEW FEATURE - Leave Group Button ---

            if (currentUserRoleInGroup === 'owner') {
                const editDescBtn = document.createElement('button');
                editDescBtn.className = 'btn btn-outline-info w-100';
                editDescBtn.innerHTML = '<i class="bi bi-pencil-fill me-2"></i> تعديل الوصف';
                editDescBtn.onclick = () => {
                    document.getElementById('group-description-textarea').value = groupData.description || '';
                    groupMembersModal.hide(); 
                    editGroupDescriptionModal.show();
                };
                membersModalFooter.appendChild(editDescBtn);
            }

            const memberIds = Object.keys(groupData.members);

            for (const memberId of memberIds) {
                const userProfile = userProfiles[memberId];
                 if (!userProfile) continue;
                
                // ### START: MODIFICATION AS PER YOUR REQUEST ###
                // This condition will skip any user with the 'developer' role from being displayed in the list.
                if (userProfile.role === 'developer') {
                    continue; 
                }
                // ### END: MODIFICATION AS PER YOUR REQUEST ###

                const memberRole = groupData.members[memberId];
                const escapedMemberName = userProfile.displayName.replace(/'/g, "\\'");
                
                let actionsHtml = '<div class="member-actions">';
                
                // --- Existing logic for Owners/Admins ---
                if (currentUserRoleInGroup === 'owner' && memberId !== currentUserId) {
                     if (memberRole === 'member') {
                        actionsHtml += `<button class="btn btn-sm btn-outline-success role-toggle-btn" onclick="window.toggleGroupAdminRole('${groupId}', '${memberId}', 'admin')">ترقية لمشرف</button>`;
                    } else if (memberRole === 'admin') {
                        actionsHtml += `<button class="btn btn-sm btn-outline-warning role-toggle-btn" onclick="window.toggleGroupAdminRole('${groupId}', '${memberId}', 'member')">تخفيض لعضو</button>`;
                    }
                }
                if ((currentUserRoleInGroup === 'owner' || currentUserRoleInGroup === 'admin') && memberRole === 'member' && memberId !== currentUserId) {
                    actionsHtml += `<button class="btn btn-sm btn-outline-danger kick-member-btn" onclick="window.kickGroupMember('${groupId}', '${memberId}', '${escapedMemberName}')">طرد</button>`;
                }
                
                // --- START: NEW FEATURE - Kick button for developers ---
                const isTargetOwner = memberRole === 'owner';
                const isTargetDeveloper = userProfile.role === 'developer';
                if (currentUserRole === 'developer' && !isTargetOwner && !isTargetDeveloper && memberId !== currentUserId) {
                     actionsHtml += `<button class="btn btn-sm text-danger kick-member-btn" onclick="window.kickGroupMember('${groupId}', '${memberId}', '${escapedMemberName}')" title="طرد بواسطة مطور"><i class="bi bi-x-circle-fill fs-5"></i></button>`;
                }
                // --- END: NEW FEATURE - Kick button for developers ---
                
                actionsHtml += '</div>';

                let roleBadge = '';
                if (memberRole === 'owner') {
                    roleBadge = '<span class="badge bg-primary role-badge">المالك</span>';
                } else if (memberRole === 'admin') {
                    roleBadge = '<span class="badge bg-success role-badge">مشرف</span>';
                }

                const memberEl = document.createElement('div');
                memberEl.className = 'group-member-item';
                memberEl.innerHTML = `
                    <img src="${userProfile.photoURL || 'https://ssl.gstatic.com/images/branding/product/1x/avatar_circle_blue_512dp.png'}" alt="Avatar">
                    <div class="flex-grow-1">${userProfile.displayName} ${roleBadge}</div>
                    ${actionsHtml}
                `;
                membersListEl.appendChild(memberEl);
            }
            groupMembersModal.show();
        }

        editGroupDescriptionForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentGroupId) return;
            const newDescription = document.getElementById('group-description-textarea').value.trim();
            const groupRef = doc(db, "groups", currentGroupId);
            try {
                await updateDoc(groupRef, { description: newDescription });
                editGroupDescriptionModal.hide();
            } catch (error) {
                console.error("Error updating description:", error);
                showCustomConfirm("فشل تحديث الوصف.", "bi bi-exclamation-triangle-fill", () => {});
            }
        });

        window.toggleGroupAdminRole = async (groupId, memberId, newRole) => {
            const groupRef = doc(db, "groups", groupId);
            await updateDoc(groupRef, {
                [`members.${memberId}`]: newRole
            });
            showGroupMembers(groupId); // Refresh modal
        };

        window.kickGroupMember = async (groupId, memberId, memberName) => {
             showCustomConfirm(
                `هل أنت متأكد من طرد "${memberName}" من المجموعة؟`,
                "bi bi-person-x-fill",
                async () => {
                    const groupRef = doc(db, "groups", groupId);
                    await updateDoc(groupRef, {
                         [`members.${memberId}`]: deleteField()
                    });
                    showGroupMembers(groupId); // Refresh the modal list
                }
            );
        };
        
        // --- START: NEW FUNCTION - Leave Group ---
        window.leaveCurrentGroup = (groupId, groupName) => {
            showCustomConfirm(
                `هل أنت متأكد أنك تريد مغادرة مجموعة "${groupName}"؟`,
                "bi bi-box-arrow-right",
                async () => {
                    const groupRef = doc(db, "groups", groupId);
                    await updateDoc(groupRef, {
                        [`members.${currentUserId}`]: deleteField()
                    });
                    groupMembersModal.hide();
                    showMainView();
                }
            );
        };
        // --- END: NEW FUNCTION - Leave Group ---

        window.requestToJoinGroup = async (groupId, btn) => {
            btn.disabled = true;
            btn.textContent = 'تم الإرسال';
            
            const requestRef = collection(db, 'joinRequests');
            const q = query(requestRef, where('groupId', '==', groupId), where('userId', '==', currentUserId));
            const existingRequests = await getDocs(q);
            if(!existingRequests.empty) {
                showCustomConfirm("لقد أرسلت طلب انضمام بالفعل لهذه المجموعة.", "bi bi-info-circle-fill", () => {});
                btn.textContent = 'الطلب مرسل';
                return;
            }
            
            await addDoc(requestRef, {
                groupId: groupId,
                userId: currentUserId,
                userName: currentDisplayName,
                status: 'pending',
                createdAt: serverTimestamp()
            });
        };
        
        function loadJoinRequests(groupId) {
            if (unsubscribeJoinRequests) unsubscribeJoinRequests();
            const q = query(collection(db, 'joinRequests'), where('groupId', '==', groupId), where('status', '==', 'pending'));
            
            unsubscribeJoinRequests = onSnapshot(q, (snapshot) => {
                if(snapshot.empty) {
                    joinRequestsContainer.innerHTML = '<p class="text-muted text-center small m-0">لا توجد طلبات انضمام حالية</p>';
                    return;
                }
                joinRequestsContainer.innerHTML = '<h6>طلبات الانضمام:</h6>';
                snapshot.forEach(doc => {
                    const request = doc.data();
                    const requestEl = document.createElement('div');
                    requestEl.className = 'join-request-item';
                    requestEl.innerHTML = `
                        <span>${request.userName}</span>
                        <div>
                            <button class="btn btn-sm btn-success" onclick="window.manageJoinRequest('${doc.id}', '${request.userId}', '${groupId}', true)">موافقة</button>
                            <button class="btn btn-sm btn-danger ms-1" onclick="window.manageJoinRequest('${doc.id}', '${request.userId}', '${groupId}', false)">رفض</button>
                        </div>
                    `;
                    joinRequestsContainer.appendChild(requestEl);
                });
            });
        }
        
        window.manageJoinRequest = async (requestId, requesterId, groupId, approve) => {
            const requestRef = doc(db, 'joinRequests', requestId);
            if (approve) {
                const groupRef = doc(db, 'groups', groupId);
                const batch = writeBatch(db);
                batch.update(groupRef, { [`members.${requesterId}`]: "member" });
                batch.delete(requestRef);
                await batch.commit();
            } else {
                await deleteDoc(requestRef);
            }
        };

        async function sendGroupMessage() {
            const text = document.getElementById('group-message-input').value.trim();
            if (!text || !currentUserId || !currentGroupId) return;
            
            const messagesRef = collection(db, "groups", currentGroupId, "messages");
            const messageData = { text, senderId: currentUserId, createdAt: serverTimestamp() };
            if(groupReplyToMessage) messageData.replyTo = groupReplyToMessage;

            await addDoc(messagesRef, messageData);
            
            document.getElementById('group-message-input').value = "";
            document.getElementById('group-message-input').style.height = 'auto';
            cancelGroupReply();
        }

        function loadGroupMessages(groupId) {
             if (unsubscribeGroupMessages) unsubscribeGroupMessages();
             const messagesRef = collection(db, "groups", groupId, "messages");
             const q = query(messagesRef, orderBy("createdAt"));
             
             unsubscribeGroupMessages = onSnapshot(q, (snapshot) => {
                 groupMessagesBox.innerHTML = '';
                 snapshot.forEach(docSnap => {
                     const msg = docSnap.data();
                     const msgId = docSnap.id;
                     const isOwn = msg.senderId === currentUserId;
                     
                     const senderProfile = userProfiles[msg.senderId] || {};
                     const displayName = senderProfile.displayName || 'مستخدم غير معروف';
                     const photoURL = senderProfile.photoURL || 'https://ssl.gstatic.com/images/branding/product/1x/avatar_circle_blue_512dp.png';
                     const currentUserRoleInGroup = currentGroupData?.members[currentUserId];
                     
                     let roleBadge = '';
                     const senderRoleInGroup = currentGroupData?.members[msg.senderId];
                     if (senderRoleInGroup === 'owner') roleBadge = '<span class="badge bg-primary role-badge">المالك</span>';
                     else if (senderRoleInGroup === 'admin') roleBadge = '<span class="badge bg-success role-badge">مشرف</span>';
                     const senderNameDisplay = `${displayName} ${roleBadge}`;
                     
                     const msgWrapper = document.createElement('div');
                     msgWrapper.className = `message ${isOwn ? 'own' : 'other'}`;
                     msgWrapper.id = `group-message-${msgId}`;
                     msgWrapper.dataset.senderId = msg.senderId;
                     msgWrapper.dataset.senderName = displayName;
                     msgWrapper.dataset.text = msg.text;

                     const time = msg.createdAt ? new Date(msg.createdAt.toDate()).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '';
                     
                     let repliedToHtml = '';
                     if (msg.replyTo) {
                        const senderHtml = `<div class="replied-to-sender">${msg.replyTo.senderName}</div>`;
                        const textHtml = `<div class="replied-to-text">${msg.replyTo.text}</div>`;
                        if (msg.replyTo.messageId) {
                            repliedToHtml = `<div class="replied-to-box" onclick="window.scrollToMessage('${msg.replyTo.messageId}', 'group-message-')" style="cursor: pointer;" title="الانتقال إلى الرسالة الأصلية">${senderHtml}${textHtml}</div>`;
                        } else {
                            repliedToHtml = `<div class="replied-to-box">${senderHtml}${textHtml}</div>`;
                        }
                     }

                     const availableReactions = ['👍', '❤️', '😂', '😮', '😢', '🙏'];
                     let reactionsContainerHtml = '<div class="reactions-container">';
                     availableReactions.forEach(emoji => {
                         reactionsContainerHtml += `<span class="reaction-emoji" onclick="window.toggleGroupReaction('${msgId}', '${emoji}')">${emoji}</span>`;
                     });
                     reactionsContainerHtml += '</div>';

                     let displayedReactionsHtml = '<div class="message-reactions">';
                     if (msg.reactions && msg.reactions.length > 0) {
                        const reactionGroups = msg.reactions.reduce((acc, r) => { (acc[r.emoji] = acc[r.emoji] || []).push(r.userId); return acc; }, {});
                        for (const emoji in reactionGroups) { displayedReactionsHtml += `<div class="reaction-chip">${emoji} ${reactionGroups[emoji].length}</div>`; }
                     }
                     displayedReactionsHtml += '</div>';

                     let actionsHtml = `<a onclick="window.setGroupReplyWrapper('${msgId}')" title="رد"><i class="bi bi-reply-fill"></i></a>`;
                     if (isOwn) {
                        actionsHtml += `<a onclick="window.editGroupMessage('${msgId}', \`${msg.text.replace(/`/g, '\\`')}\`)" title="تعديل"><i class="bi bi-pencil-fill"></i></a>`;
                        actionsHtml += `<a onclick="window.deleteOwnGroupMessage('${msgId}')" title="حذف"><i class="bi bi-trash-fill"></i></a>`;
                     }

                     if (currentUserRoleInGroup === 'owner' || currentUserRoleInGroup === 'admin') {
                        actionsHtml += `<a onclick="window.pinGroupMessage('${msgId}')" title="تثبيت"><i class="bi bi-pin-angle-fill"></i></a>`;
                        if (!isOwn) {
                            actionsHtml += `<a onclick="window.deleteOtherGroupMessage('${msgId}')" title="حذف (إدارة)"><i class="bi bi-shield-x"></i></a>`;
                        }
                     }
                     
                     const actions = `<div class="message-actions">${actionsHtml}</div>`;

                     const editedBadge = msg.isEdited ? `<span class="edited-badge">(تم التعديل)</span>` : '';

                     msgWrapper.innerHTML = `
                        <img src="${photoURL}" alt="${displayName}" class="avatar">
                        <div class="message-bubble">
                            <div class="message-content">
                                ${reactionsContainerHtml}
                                ${!isOwn ? `<div class="sender">${senderNameDisplay}</div>` : ''}
                                ${repliedToHtml}
                                <div class="message-text">${msg.text}</div>
                                <div class="timestamp-wrapper">
                                    <span class="timestamp">${time}</span>
                                    ${editedBadge}
                                </div>
                                ${displayedReactionsHtml}
                            </div>
                            ${actions}
                        </div>
                     `;
                     groupMessagesBox.appendChild(msgWrapper);
                 });
                 groupMessagesBox.scrollTop = groupMessagesBox.scrollHeight;
             });
        }
        
        window.setGroupReplyWrapper = (msgId) => {
            event.stopPropagation();
            const el = document.getElementById(`group-message-${msgId}`);
            if (el) setGroupReplyFromElement(el);
        };
        
        function setGroupReplyFromElement(el) {
            const msgId = el.id.replace('group-message-', '');
            const senderName = el.dataset.senderName;
            const senderId = el.dataset.senderId;
            const text = el.dataset.text;
            const firstLine = text.split('\n')[0];
            if (senderName && senderId && text) {
                groupReplyToMessage = { messageId: msgId, senderName, senderId, text: firstLine };
                document.getElementById('group-reply-preview-sender').textContent = `الرد على ${senderName}`;
                document.getElementById('group-reply-preview-text').textContent = firstLine;
                document.getElementById('group-reply-preview').style.display = 'block';
                document.getElementById('group-message-input').focus();
            }
        }

        function cancelGroupReply() {
            groupReplyToMessage = null;
            document.getElementById('group-reply-preview').style.display = 'none';
        }
        
        window.toggleGroupReaction = async (msgId, emoji) => {
            if (!currentUserId || !currentGroupId) return;
            const msgRef = doc(db, "groups", currentGroupId, "messages", msgId);
            const msgDoc = await getDoc(msgRef);
            if (!msgDoc.exists()) return;

            const msgData = msgDoc.data();
            const reactions = msgData.reactions || [];
            const existingReaction = reactions.find(r => r.userId === currentUserId);

            if (existingReaction) {
                const newReactions = reactions.filter(r => r.userId !== currentUserId);
                if (existingReaction.emoji !== emoji) {
                    newReactions.push({ userId: currentUserId, emoji });
                }
                await updateDoc(msgRef, { reactions: newReactions });
            } else {
                await updateDoc(msgRef, { reactions: arrayUnion({ userId: currentUserId, emoji }) });
            }
        };

        const cloudinaryWidget = cloudinary.createUploadWidget({
            cloudName: 'dzx6pjhks', 
            uploadPreset: 'group_photo',
            sources: ['local', 'url', 'camera'],
            multiple: false,
            cropping: true,
            croppingAspectRatio: 1,
            showSkipCropButton: false
        }, (error, result) => { 
            if (!error && result && result.event === "success") {
                const groupRef = doc(db, "groups", window.currentUploadingGroupId);
                updateDoc(groupRef, { groupPhotoURL: result.info.secure_url })
                    .then(() => {
                        window.currentUploadingGroupId = null; // Clear temp state
                        deleteGroupPhotoBtn.style.display = 'flex';
                    });
            }
        });
        
        function uploadGroupPhoto(groupId) {
            window.currentUploadingGroupId = groupId; // Temp store for widget callback
            cloudinaryWidget.open();
        }
        
        async function deleteGroupPhoto(groupId){
             showCustomConfirm(
                `هل أنت متأكد من حذف صورة المجموعة؟`,
                "bi bi-image-alt",
                async () => {
                    const groupRef = doc(db, "groups", groupId);
                    await updateDoc(groupRef, { groupPhotoURL: null });
                    deleteGroupPhotoBtn.style.display = 'none';
                }
            );
        }
        
        // --- END: Group System Logic ---

        // --- START: Group Message Actions ---
        window.editGroupMessage = (msgId, text) => {
            editingMessageInfo = { id: msgId, collectionPath: `groups/${currentGroupId}/messages` };
            editMessageTextarea.value = text;
            editMessageModalEl.classList.add('show');
            editMessageTextarea.focus();
        };

        window.deleteOwnGroupMessage = async (msgId) => {
            showCustomConfirm("هل أنت متأكد من حذف رسالتك؟", "bi bi-trash-fill", async () => {
                await deleteDoc(doc(db, "groups", currentGroupId, "messages", msgId));
            });
        };

        window.deleteOtherGroupMessage = async (msgId) => {
            showCustomConfirm("هل أنت متأكد من حذف هذه الرسالة؟ (إجراء إداري)", "bi bi-shield-x", async () => {
                await deleteDoc(doc(db, "groups", currentGroupId, "messages", msgId));
            });
        };

        window.pinGroupMessage = async (messageId) => {
            const messageRef = doc(db, "groups", currentGroupId, "messages", messageId);
            const messageSnap = await getDoc(messageRef);
            if (!messageSnap.exists()) return;
            const messageData = messageSnap.data();

            const pinnedData = {
                messageId: messageId,
                text: messageData.text,
                senderName: userProfiles[messageData.senderId]?.displayName || 'عضو',
                pinnedBy: currentDisplayName
            };

            await updateDoc(doc(db, "groups", currentGroupId), { pinnedMessage: pinnedData });
        };
        
        window.unpinGroupMessage = async () => {
             await updateDoc(doc(db, "groups", currentGroupId), { pinnedMessage: deleteField() });
        };

        function loadGroupPinnedMessage(groupId) {
            if (unsubscribeGroupDoc) unsubscribeGroupDoc();
            unsubscribeGroupDoc = onSnapshot(doc(db, "groups", groupId), (docSnap) => {
                if (docSnap.exists()) {
                    currentGroupData = docSnap.data(); // Keep group data fresh
                    const pinned = docSnap.data().pinnedMessage;
                    const currentUserRoleInGroup = currentGroupData?.members[currentUserId];
                    const canManagePin = currentUserRoleInGroup === 'owner' || currentUserRoleInGroup === 'admin';

                    if (pinned && pinned.text) {
                        groupPinnedByText.textContent = `تم التثبيت بواسطة: ${pinned.pinnedBy}`;
                        groupPinnedMessageText.textContent = `${pinned.senderName}: ${pinned.text}`;
                        groupPinnedMessageContainer.style.display = 'block';
                        groupUnpinButton.style.display = canManagePin ? 'block' : 'none';
                        groupUnpinButton.onclick = () => window.unpinGroupMessage();
                    } else {
                        groupPinnedMessageContainer.style.display = 'none';
                    }
                }
            });
        }

        // --- END: Group Message Actions ---
        
        // --- START: Private Chat Logic ---
        function setPrivateReplyFromElement(el) {
            const msgId = el.id.replace('private-message-', '');
            const senderName = el.dataset.senderName;
            const senderId = el.dataset.senderId;
            const text = el.dataset.text;
            const firstLine = text.split('\n')[0];

            if (senderName && senderId && text) {
                privateReplyToMessage = { messageId: msgId, senderName, senderId, text: firstLine };
                document.getElementById('private-reply-preview-sender').textContent = `الرد على ${senderName}`;
                document.getElementById('private-reply-preview-text').textContent = firstLine;
                document.getElementById('private-reply-preview').style.display = 'block';
                privateMessageInput.focus();
            }
        }

        function cancelPrivateReply() {
            privateReplyToMessage = null;
            document.getElementById('private-reply-preview').style.display = 'none';
        }
        document.getElementById('cancel-private-reply').addEventListener('click', cancelPrivateReply);

        async function sendPrivateMessage() {
            const text = privateMessageInput.value.trim();
            if (!text || !currentUserId || !privateChatRoomId || !recipientId) return;
            
            const messagesRef = collection(db, "private_chats", privateChatRoomId, "messages");
            const messageData = {
                text,
                senderId: currentUserId,
                recipientId: recipientId,
                createdAt: serverTimestamp(),
                status: 'sent'
            };
            
            if (privateReplyToMessage) {
                messageData.replyTo = privateReplyToMessage;
            }

            await addDoc(messagesRef, messageData);
            
            const chatRoomRef = doc(db, "private_chats", privateChatRoomId);
            await updateDoc(chatRoomRef, {
                lastMessage: text,
                lastMessageTimestamp: serverTimestamp(),
                [`unread_count_${recipientId}`]: increment(1),
                [`hidden_for_${currentUserId}`]: false,
                [`hidden_for_${recipientId}`]: false
            });

            privateMessageInput.value = "";
            privateMessageInput.style.height = 'auto';
            cancelPrivateReply();
        }

        function loadPrivateMessages() {
            if (unsubscribePrivateChat) unsubscribePrivateChat();
            const messagesRef = collection(db, "private_chats", privateChatRoomId, "messages");
            const q = query(messagesRef, orderBy("createdAt"));
            unsubscribePrivateChat = onSnapshot(q, (snapshot) => {
                privateMessagesBox.innerHTML = '';
                snapshot.forEach(docSnap => {
                    const msg = docSnap.data();
                    const msgId = docSnap.id;
                    
                    if (msg.senderId === recipientId && msg.status !== 'seen') {
                        const msgRef = doc(db, "private_chats", privateChatRoomId, "messages", msgId);
                        updateDoc(msgRef, { status: 'seen' });
                    }

                    const isOwn = msg.senderId === currentUserId;
                    const msgWrapper = document.createElement('div');
                    msgWrapper.className = `private-message-wrapper ${isOwn ? 'own' : 'other'}`;
                    const time = msg.createdAt ? new Date(msg.createdAt.toDate()).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '';
                    
                    const senderProfile = userProfiles[msg.senderId] || {};
                    const senderName = senderProfile.displayName || '...';
                    msgWrapper.id = `private-message-${msgId}`;
                    msgWrapper.dataset.senderId = msg.senderId;
                    msgWrapper.dataset.senderName = senderName;
                    msgWrapper.dataset.text = msg.text;

                    const availableReactions = ['👍', '❤️', '😂', '😮', '😢', '🙏'];
                    let reactionsContainerHtml = '<div class="reactions-container">';
                    availableReactions.forEach(emoji => {
                        reactionsContainerHtml += `<span class="reaction-emoji" onclick="window.togglePrivateReaction('${msgId}', '${emoji}')">${emoji}</span>`;
                    });
                    reactionsContainerHtml += '</div>';

                    let displayedReactionsHtml = '<div class="message-reactions">';
                    if (msg.reactions && msg.reactions.length > 0) {
                        const reactionGroups = msg.reactions.reduce((acc, r) => {
                            acc[r.emoji] = (acc[r.emoji] || 0) + 1;
                            return acc;
                        }, {});
                        for (const e in reactionGroups) {
                            displayedReactionsHtml += `<div class="reaction-chip">${e} ${reactionGroups[e]}</div>`;
                        }
                    }
                    displayedReactionsHtml += '</div>';

                    const isDeveloper = currentUserRole === 'developer';
                    let copyButtonHtml = '';
                    if (isDeveloper) {
                        copyButtonHtml = `<a onclick="window.copyPrivateMessageText('${msgId}')" title="نسخ"><i class="bi bi-clipboard"></i></a>`;
                    }

                    let controls = '';
                    if (isOwn) {
                        controls = `
                            <div class="message-actions">
                                ${copyButtonHtml}
                                <a onclick="window.editPrivateMessage('${msgId}', \`${msg.text.replace(/`/g, '\\`')}\`)" title="تعديل"><i class="bi bi-pencil-fill"></i></a>
                                <a onclick="window.deletePrivateMessage('${msgId}')" title="حذف"><i class="bi bi-trash-fill"></i></a>
                            </div>
                        `;
                    } else if (isDeveloper) {
                         controls = `
                            <div class="message-actions">
                                ${copyButtonHtml}
                            </div>
                        `;
                    }
                    
                    let receiptIcon = '';
                    if (isOwn) {
                        receiptIcon = msg.status === 'seen' 
                            ? `<i class="bi bi-check2-all read-receipt seen"></i>` 
                            : `<i class="bi bi-check2 read-receipt sent"></i>`;
                    }
                    
                    const editedBadge = msg.isEdited ? `<span class="edited-badge">(تم التعديل)</span>` : '';

                    let repliedToHtml = '';
                    if (msg.replyTo) {
                        const senderHtml = `<div class="replied-to-sender">${msg.replyTo.senderName}</div>`;
                        const textHtml = `<div class="replied-to-text">${msg.replyTo.text}</div>`;
                        if (msg.replyTo.messageId) {
                            repliedToHtml = `<div class="replied-to-box" onclick="window.scrollToMessage('${msg.replyTo.messageId}', 'private-message-')" style="cursor: pointer;" title="الانتقال إلى الرسالة الأصلية">${senderHtml}${textHtml}</div>`;
                        } else {
                            repliedToHtml = `<div class="replied-to-box">${senderHtml}${textHtml}</div>`;
                        }
                    }
                    
                    msgWrapper.innerHTML = `
                        <div class="message-content">
                            ${reactionsContainerHtml}
                            ${repliedToHtml}
                            <div class="private-message-text">${msg.text}</div>
                            <div class="timestamp-wrapper" style="justify-content: flex-end;">
                                ${receiptIcon}
                                <span class="timestamp">${time}</span>
                                ${editedBadge}
                            </div>
                            ${displayedReactionsHtml}
                        </div>
                        ${controls}
                    `;
                    privateMessagesBox.appendChild(msgWrapper);
                });
                privateMessagesBox.scrollTop = privateMessagesBox.scrollHeight;
            });
        }
        
        window.deletePrivateMessage = async (messageId) => {
            if (!privateChatRoomId || !messageId) return;
            showCustomConfirm(
                "هل أنت متأكد من حذف هذه الرسالة للجميع؟",
                "bi bi-trash-fill",
                async () => {
                     const msgRef = doc(db, "private_chats", privateChatRoomId, "messages", messageId);
                     await deleteDoc(msgRef);
                }
            );
        }
        
        userSearchInput.addEventListener('input', (e) => {
            const searchTerm = e.target.value.trim();
            const listTitle = document.getElementById('conversation-list-title');
            const userListContainer = document.getElementById('users-list-container').querySelector('#conversation-list');
            if (searchTerm.length > 0) {
                if(listTitle) listTitle.style.display = 'none';
                searchUsers(searchTerm);
            } else {
                if(listTitle) listTitle.style.display = 'block';
                document.getElementById('users-list-container').querySelector('#search-results')?.remove();
                renderPrivateConversations();
            }
        });

        async function searchUsers(name) {
            const usersRef = collection(db, "users");
            const q = query(usersRef, where("displayName", ">=", name), where("displayName", "<=", name + '\uf8ff'), limit(10));
            const querySnapshot = await getDocs(q);
            const usersListContainerEl = document.getElementById('users-list-container');
            let searchResultsEl = usersListContainerEl.querySelector('#search-results');
            if (!searchResultsEl) {
                searchResultsEl = document.createElement('div');
                searchResultsEl.id = 'search-results';
                usersListContainerEl.prepend(searchResultsEl);
            }
            
            let searchResultsHtml = '';
            if(querySnapshot.empty){
                 searchResultsHtml = '<p class="text-center text-muted p-3">لم يتم العثور على مستخدمين</p>';
            }
            querySnapshot.forEach((doc) => {
                if (doc.id === currentUserId) return;
                const userData = doc.data();
                searchResultsHtml += `
                    <div class="user-list-item" onclick="window.startPrivateChatFromSearch('${doc.id}', '${userData.displayName.replace(/'/g, "\\'")}', '${userData.photoURL || ''}')">
                        <img src="${userData.photoURL || 'https://ssl.gstatic.com/images/branding/product/1x/avatar_circle_blue_512dp.png'}" alt="Avatar">
                        <span class="user-name">${userData.displayName || 'مستخدم'}</span>
                    </div>
                `;
            });
            searchResultsEl.innerHTML = searchResultsHtml;
        }
        
        window.startPrivateChatFromSearch = (id, name, avatar) => {
            showPrivateChatView(id, name, avatar);
            userSearchInput.value = '';
            const searchResultsEl = document.getElementById('users-list-container').querySelector('#search-results');
            if(searchResultsEl) searchResultsEl.innerHTML = '';
            document.getElementById('conversation-list-title').style.display = 'block';
            renderPrivateConversations();
        };
        
        function renderPrivateConversations(conversations = []) {
             if (userSearchInput.value.trim() !== '') return;

             if (conversations.length === 0) {
                 usersListContainer.innerHTML = '<p class="text-center text-muted p-3">لا توجد محادثات خاصة بعد</p>';
                 return;
             }
             
             usersListContainer.innerHTML = '';
             for (const conv of conversations) {
                 const chatRoom = conv.data;
                 const chatRoomId = conv.id;
                 
                 if (chatRoom[`hidden_for_${currentUserId}`]) continue;

                 const otherUserId = chatRoom.participants.find(id => id !== currentUserId);
                 if (!otherUserId) continue;
                 
                 const userData = userProfiles[otherUserId];
                 if (userData) {
                     const chatDiv = document.createElement('div');
                     chatDiv.className = 'conversation-list-item';
                     
                     const unreadCount = chatRoom[`unread_count_${currentUserId}`] || 0;
                     const unreadBadgeHTML = unreadCount > 0 ? `<span class="unread-badge">${unreadCount}</span>` : '';
                     const notificationDotHTML = unreadCount > 0 ? `<span class="notification-dot"></span>` : '';
                     
                     chatDiv.innerHTML = `
                         <div class="avatar-container">
                             <img src="${userData.photoURL || 'https://ssl.gstatic.com/images/branding/product/1x/avatar_circle_blue_512dp.png'}" alt="Avatar">
                             ${notificationDotHTML}
                         </div>
                         <div class="conversation-info flex-grow-1">
                              <div class="user-name">${userData.displayName || 'مستخدم'}</div>
                              <div class="last-message">${chatRoom.lastMessage || '...'}</div>
                         </div>
                         ${unreadBadgeHTML}
                         <i class="bi bi-x-circle delete-chat-btn" data-chatroom-id="${chatRoomId}"></i>
                     `;
                     chatDiv.addEventListener('click', (e) => {
                          if (!e.target.classList.contains('delete-chat-btn')) {
                             showPrivateChatView(otherUserId, userData.displayName, userData.photoURL);
                          }
                     });
                     usersListContainer.appendChild(chatDiv);
                 }
             }
              document.querySelectorAll('.delete-chat-btn').forEach(btn => {
                 btn.addEventListener('click', async (e) => {
                     e.stopPropagation();
                     const chatRoomId = e.target.dataset.chatroomId;
                     showCustomConfirm(
                         "هل أنت متأكد من حذف هذه المحادثة من قائمتك؟",
                         "bi bi-trash-fill",
                         async () => {
                            const chatRoomRef = doc(db, "private_chats", chatRoomId);
                            await updateDoc(chatRoomRef, { [`hidden_for_${currentUserId}`]: true });
                         }
                     );
                 });
             });
        }

        async function loadPrivateConversations() {
            if (!currentUserId) return;

            if (unsubscribeConversations) {
                unsubscribeConversations();
            }

            const chatRoomsRef = collection(db, "private_chats");
            const q = query(chatRoomsRef, where("participants", "array-contains", currentUserId));
            
            unsubscribeConversations = onSnapshot(q, async (snapshot) => {
                const conversations = [];
                let totalUnreadCount = 0; 
                
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (!data[`hidden_for_${currentUserId}`]) {
                        totalUnreadCount += (data[`unread_count_${currentUserId}`] || 0);
                    }
                    conversations.push({ id: docSnap.id, data: data });
                });

                conversations.sort((a, b) => {
                    const timeA = a.data.lastMessageTimestamp?.toDate() || 0;
                    const timeB = b.data.lastMessageTimestamp?.toDate() || 0;
                    return timeB - timeA;
                });
                
                const notificationBadge = document.getElementById('private-chat-notification-badge');
                if (notificationBadge) {
                    if (totalUnreadCount > 0) {
                        notificationBadge.textContent = totalUnreadCount > 99 ? '99+' : totalUnreadCount;
                        notificationBadge.style.display = 'block';
                    } else {
                        notificationBadge.style.display = 'none';
                    }
                }
                
                renderPrivateConversations(conversations);
            });
        }

        privateSendButton.addEventListener('click', sendPrivateMessage);
        privateMessageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendPrivateMessage(); } });
        privateMessageInput.addEventListener('input', () => { privateMessageInput.style.height = 'auto'; privateMessageInput.style.height = (privateMessageInput.scrollHeight) + 'px'; });
        
        async function toggleBlockUser(shouldBlock) {
            if (!currentUserId || !recipientId) return;
            
            const confirmMessage = shouldBlock 
                ? `هل أنت متأكد من حظر ${recipientNameEl.textContent}؟`
                : `هل أنت متأكد من إلغاء حظر ${recipientNameEl.textContent}؟`;

            showCustomConfirm(
                confirmMessage,
                "bi bi-slash-circle-fill",
                async () => {
                    const currentUserRef = doc(db, "users", currentUserId);
                    const userUpdate = { blockedUsers: shouldBlock ? arrayUnion(recipientId) : arrayRemove(recipientId) };
                    await updateDoc(currentUserRef, userUpdate);
                    showCustomConfirm(shouldBlock ? "تم حظر المستخدم بنجاح." : "تم إلغاء حظر المستخدم بنجاح.", "bi bi-check-circle-fill", () => {});
                }
            );
        }

        window.editPrivateMessage = (id, text) => {
            editingMessageInfo = { id: id, collectionPath: `private_chats/${privateChatRoomId}/messages` };
            editMessageTextarea.value = text;
            editMessageModalEl.classList.add('show');
            editMessageTextarea.focus();
        };

        window.copyPrivateMessageText = async (msgId) => {
            const textElement = document.querySelector(`#private-message-${msgId} .private-message-text`);
            if (textElement) {
                try {
                    await navigator.clipboard.writeText(textElement.innerText);
                    // This is a small notification, so a native alert is acceptable here for simplicity.
                    alert("تم نسخ النص!");
                } catch (err) {
                    console.error('Failed to copy text: ', err);
                    alert("فشل نسخ النص.");
                }
            }
        };

        window.togglePrivateReaction = async (msgId, emoji) => {
            if (!currentUserId || !privateChatRoomId) return;
            const msgRef = doc(db, "private_chats", privateChatRoomId, "messages", msgId);
            const msgDoc = await getDoc(msgRef);
            if (!msgDoc.exists()) return;

            const msgData = msgDoc.data();
            const reactions = msgData.reactions || [];
            const existingReaction = reactions.find(r => r.userId === currentUserId);

            if (existingReaction) {
                const newReactions = reactions.filter(r => r.userId !== currentUserId);
                if (existingReaction.emoji !== emoji) {
                    newReactions.push({ userId: currentUserId, emoji });
                }
                await updateDoc(msgRef, { reactions: newReactions });
            } else {
                await updateDoc(msgRef, { reactions: arrayUnion({ userId: currentUserId, emoji }) });
            }
        };
        // --- END: Private Chat Logic ---

        // --- START: General & User Profile Logic ---
        function getVisitorProfile() { try { return JSON.parse(localStorage.getItem('visitorProfile')) || {}; } catch (e) { return {}; } }
        
        function updateExistingDomNames() {
            if(userProfiles[currentUserId]) {
                currentDisplayName = userProfiles[currentUserId].displayName;
                currentUserRole = userProfiles[currentUserId].role || 'user'; // Ensure role is updated
                let roleText = '';
                if (currentUserRole === 'developer') roleText = '⭐ (مطور)';
                else if (currentUserRole === 'admin') roleText = '🛡️ (مشرف)';
                if(userDisplayName) { // Check if element exists before updating
                    userDisplayName.textContent = `مرحبا، ${currentDisplayName} ${roleText}`;
                }
            }

            document.querySelectorAll('#messages-box .message').forEach(msgEl => {
                const senderId = msgEl.dataset.senderId;
                const senderNameEl = msgEl.querySelector('.sender');
                if (senderId && senderNameEl && userProfiles[senderId]) {
                    let roleBadge = '';
                    const profile = userProfiles[senderId];
                    if (profile.role === 'developer') roleBadge = '⭐ (مطور)';
                    else if (profile.role === 'admin') roleBadge = '🛡️ (مشرف)';
                    senderNameEl.textContent = `${profile.displayName || 'مستخدم'} ${roleBadge}`;
                }
            });
            
            loadPrivateConversations();

            if (privateChatView.classList.contains('active') && recipientId && userProfiles[recipientId]) {
                recipientNameEl.textContent = userProfiles[recipientId].displayName;
            }
        }

        function listenForUserProfiles() {
            if (unsubscribeUserProfiles) {
                unsubscribeUserProfiles();
            }
            const usersRef = collection(db, "users");
            unsubscribeUserProfiles = onSnapshot(usersRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    userProfiles[change.doc.id] = change.doc.data();
                });
                updateExistingDomNames(); 
            });
        }

        async function checkUserStatus(userId) { const userDoc = await getDoc(doc(db, "users", userId)); if (userDoc.exists()) { const userData = userDoc.data(); if (userData.isBanned) return 'banned'; if (userData.mutedUntil && userData.mutedUntil.toDate() > new Date()) return 'muted'; currentUserRole = userData.role || 'user'; } else { await setDoc(doc(db, "users", userId), { role: 'user' }, { merge: true }); currentUserRole = 'user'; } return 'active'; }
        // --- END: General & User Profile Logic ---

        // --- START: Public Chat Logic ---
        async function sendMessage() {
            const text = messageInput.value.trim();
            if (!text || !auth.currentUser) return;
            if (!isVisitor) { const userStatus = await checkUserStatus(auth.currentUser.uid); if (userStatus === 'muted') { showCustomConfirm("أنت مكتوم حاليا ولا يمكنك إرسال رسائل.", "bi bi-mic-mute-fill", () => {}); return; } }
            const messageData = { text, senderName: currentDisplayName, senderId: auth.currentUser.uid, senderRole: currentUserRole, createdAt: serverTimestamp() };
            if (replyToMessage) { messageData.replyTo = replyToMessage; }
            await addDoc(collection(db, "messages"), messageData);
            messageInput.value = ""; cancelReply(); messageInput.style.height = 'auto';
        }
        sendButton.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); } });
        messageInput.addEventListener('input', () => { messageInput.style.height = 'auto'; messageInput.style.height = (messageInput.scrollHeight) + 'px'; });
        function cancelReply() { replyToMessage = null; replyPreview.style.display = 'none'; }
        cancelReplyButton.addEventListener('click', cancelReply);

        function loadMessages() {
            const q = query(collection(db, "messages"), orderBy("createdAt"));
            onSnapshot(q, (snapshot) => {
                const wasScrolledToBottom = messagesBox.scrollHeight - messagesBox.clientHeight <= messagesBox.scrollTop + 150;
                messagesBox.innerHTML = "";
                snapshot.forEach(messageDoc => {
                    const msg = messageDoc.data(); const msgId = messageDoc.id; const isOwn = msg.senderId === auth.currentUser?.uid;
                    const msgDiv = document.createElement('div'); 
                    msgDiv.className = `message ${isOwn ? 'own' : 'other'}`;
                    msgDiv.id = `message-${msgId}`;
                    msgDiv.dataset.senderName = msg.senderName; 
                    msgDiv.dataset.senderId = msg.senderId; 
                    msgDiv.dataset.text = msg.text;
                    
                    const senderProfile = userProfiles[msg.senderId] || {};
                    const displayName = senderProfile.displayName || msg.senderName;
                    const photoURL = senderProfile.photoURL || 'https://ssl.gstatic.com/images/branding/product/1x/avatar_circle_blue_512dp.png';
                    const escapedDisplayName = displayName.replace(/'/g, "\\'");
                    const startPrivateChatIcon = !isOwn ? `<a onclick="window.startPrivateChatFromGroup('${msg.senderId}', '${escapedDisplayName}', '${photoURL}')" title="بدء دردشة خاصة" style="cursor: pointer;"><i class="bi bi-send"></i></a>` : '';
                    
                    let roleBadge = '';
                    if (senderProfile.role === 'developer') roleBadge = '⭐ (مطور)';
                    else if (senderProfile.role === 'admin') roleBadge = '🛡️ (مشرف)';
                    
                    const senderNameDisplay = `${displayName} ${roleBadge}`;
                    const avatarHtml = `<img src="${photoURL}" alt="${displayName}" class="avatar">`;

                    const messageBubble = document.createElement('div');
                    messageBubble.className = 'message-bubble';
                    const time = msg.createdAt ? new Date(msg.createdAt.toDate()).toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }) : '';
                    const canModerate = !isVisitor && (currentUserRole === 'developer' || currentUserRole === 'admin');
                    let controls = '';
                    const pinButton = canModerate ? `<a onclick="window.pinMessage('${msgId}')" title="تثبيت"><i class="bi bi-pin-angle-fill"></i></a>` : '';
                    const replyButton = `<a onclick="window.setReplyWrapper('${msgId}')" title="رد"><i class="bi bi-reply-fill"></i></a>`;
                    const copyButton = `<a onclick="window.copyMessageText('${msgId}')" title="نسخ"><i class="bi bi-clipboard"></i></a>`;
                    if (isOwn) {
                        controls = `<div class="message-actions">${copyButton}${replyButton}<a onclick="window.editPublicMessage('${msgId}', \`${msg.text.replace(/`/g, '\\`')}\`)" title="تعديل"><i class="bi bi-pencil-fill"></i></a><a onclick="window.deleteOwnMessage('${msgId}')" title="حذف"><i class="bi bi-trash-fill"></i></a>${pinButton}</div>`;
                    } else {
                        let actionButtons = `${startPrivateChatIcon}${copyButton}${replyButton}`;
                        if(canModerate){
                            actionButtons += `<a onclick="window.deleteOtherMessage('${msgId}')" title="حذف"><i class="bi bi-trash-fill"></i></a>`;
                            const isTargetDeveloper = senderProfile.role === 'developer'; 
                            const isTargetAdmin = senderProfile.role === 'admin';
                            if (currentUserRole === 'developer' && !isTargetDeveloper) { actionButtons += `<a onclick="window.toggleAdminRole('${msg.senderId}', '${escapedDisplayName}')" title="تغيير دور المشرف"><i class="bi bi-shield-fill"></i></a>`; }
                            actionButtons += pinButton;
                            if (!isTargetAdmin && !isTargetDeveloper) {
                                const muteDropdownId = `mute-dropdown-${msgId}`;
                                const muteOptions = `<div id="${muteDropdownId}" class="mute-dropdown"><a href="#" onclick="window.muteUser('${msg.senderId}', '${escapedDisplayName}', 1)">دقيقة</a><a href="#" onclick="window.muteUser('${msg.senderId}', '${escapedDisplayName}', 5)">5 دقائق</a><a href="#" onclick="window.muteUser('${msg.senderId}', '${escapedDisplayName}', 15)">ربع ساعة</a><a href="#" onclick="window.muteUser('${msg.senderId}', '${escapedDisplayName}', 1440)">يوم</a><a href="#" onclick="window.unmuteUser('${msg.senderId}', '${escapedDisplayName}')" style="color: #00a884;">إلغاء الكتم</a></div>`;
                                const muteButton = `<a onclick="event.stopPropagation(); window.toggleMuteDropdown('${muteDropdownId}')" title="كتم"><i class="bi bi-bell-slash-fill"></i></a>`;
                                const banButton = `<a onclick="window.banUser('${msg.senderId}', '${escapedDisplayName}')" title="حظر"><i class="bi bi-slash-circle-fill"></i></a>`;
                                actionButtons += `${muteButton}${banButton}${muteOptions}`;
                            }
                        }
                        controls = `<div class="message-actions">${actionButtons}</div>`;
                    }
                    const editedBadge = msg.isEdited ? `<span class="edited-badge">(تم التعديل)</span>` : '';
                    let repliedToHtml = '';
                    if (msg.replyTo) {
                        const senderHtml = `<div class="replied-to-sender">@${msg.replyTo.senderName}</div>`;
                        const textHtml = `<div class="replied-to-text">${msg.replyTo.text}</div>`;
                        if (msg.replyTo.messageId) {
                            repliedToHtml = `<div class="replied-to-box" onclick="window.scrollToMessage('${msg.replyTo.messageId}', 'message-')" style="cursor: pointer;" title="الانتقال إلى الرسالة الأصلية">${senderHtml}${textHtml}</div>`;
                        } else {
                            repliedToHtml = `<div class="replied-to-box">${senderHtml}${textHtml}</div>`;
                        }
                    }
                    const availableReactions = ['👍', '❤️', '😂', '😮', '😢', '🙏']; let reactionsContainerHtml = '<div class="reactions-container">'; availableReactions.forEach(emoji => { reactionsContainerHtml += `<span class="reaction-emoji" onclick="window.toggleReaction('${msgId}', '${emoji}')">${emoji}</span>`; }); reactionsContainerHtml += '</div>';
                    let displayedReactionsHtml = '<div class="message-reactions">'; if (msg.reactions && msg.reactions.length > 0) { const reactionGroups = msg.reactions.reduce((acc, r) => { acc[r.emoji] = (acc[r.emoji] || 0) + 1; return acc; }, {}); for (const e in reactionGroups) { displayedReactionsHtml += `<div class="reaction-chip">${e} ${reactionGroups[e]}</div>`; } } displayedReactionsHtml += '</div>';
                    const messageContentHtml = `<div class="message-content">${reactionsContainerHtml}${!isOwn ? `<div class="sender">${senderNameDisplay}</div>` : ''}${repliedToHtml}<div class="message-text">${msg.text}</div><div class="timestamp-wrapper"><span class="timestamp">${time}</span>${editedBadge}</div>${displayedReactionsHtml}</div>`;
                    messageBubble.innerHTML = messageContentHtml + controls;
                    msgDiv.innerHTML = avatarHtml; msgDiv.appendChild(messageBubble); messagesBox.appendChild(msgDiv);
                });
                if (wasScrolledToBottom) { messagesBox.scrollTop = messagesBox.scrollHeight; }
            });
        }
        window.startPrivateChatFromGroup = (targetUserId, targetUserName, targetUserAvatar) => { showPrivateChatView(targetUserId, targetUserName, targetUserAvatar); };
        const pinnedDocRef = doc(db, "chat_config", "pinned_message");
        window.pinMessage = async (messageId) => { if (isVisitor) return; const messageDoc = await getDoc(doc(db, "messages", messageId)); if (!messageDoc.exists()) return; const messageData = messageDoc.data(); await setDoc(pinnedDocRef, { messageId: messageId, text: messageData.text, senderName: messageData.senderName, pinnedBy: currentDisplayName, pinnedAt: serverTimestamp() }); };
        unpinButton.addEventListener('click', async (e) => { e.stopPropagation(); if(isVisitor) return; await setDoc(pinnedDocRef, { messageId: null, text: null, senderName: null, pinnedBy: null }); });
        function loadPinnedMessage() { onSnapshot(pinnedDocRef, (doc) => { if (doc.exists() && doc.data().text) { const data = doc.data(); pinnedByText.textContent = `تم التثبيت بواسطة: ${data.pinnedBy}`; pinnedMessageText.textContent = `${data.senderName}: ${data.text}`; pinnedMessageContainer.style.display = 'block'; pinnedMessageContainer.dataset.messageId = data.messageId; unpinButton.style.display = (!isVisitor && (currentUserRole === 'developer' || currentUserRole === 'admin')) ? 'block' : 'none'; } else { pinnedMessageContainer.style.display = 'none'; pinnedMessageContainer.dataset.messageId = ''; } }); }
        pinnedMessageClickableArea.addEventListener('click', () => { const messageId = pinnedMessageContainer.dataset.messageId; if (!messageId) return; const messageElement = document.getElementById(`message-${messageId}`); if (messageElement) { messageElement.scrollIntoView({ behavior: 'smooth', block: 'center' }); messageElement.style.transition = 'background-color 0.5s'; messageElement.style.backgroundColor = 'rgba(255, 255, 0, 0.3)'; setTimeout(() => { messageElement.style.backgroundColor = ''; }, 2000); } });
        window.toggleMuteDropdown = (id) => { event.stopPropagation(); document.querySelectorAll(".mute-dropdown").forEach(d => { if(d.id !== id) d.classList.remove('show-dropdown'); }); document.getElementById(id).classList.toggle("show-dropdown"); }
        window.onclick = (e) => { if (!e.target.matches('.bi-bell-slash-fill')) { document.querySelectorAll(".mute-dropdown.show-dropdown").forEach(d => d.classList.remove('show-dropdown')); } }
        window.muteUser = async (uid, name, min) => { if (!['developer', 'admin'].includes(currentUserRole)) return; await setDoc(doc(db, "users", uid), { mutedUntil: new Date(Date.now() + min * 60000) }, { merge: true }); showCustomConfirm(`تم كتم ${name} لمدة ${min} دقيقة.`, "bi bi-mic-mute-fill", () => {}); };
        window.unmuteUser = async (uid, name) => { if (!['developer', 'admin'].includes(currentUserRole)) return; await setDoc(doc(db, "users", uid), { mutedUntil: null }, { merge: true }); showCustomConfirm(`تم إلغاء كتم ${name}.`, "bi bi-mic-fill", () => {}); };
        function setReplyFromElement(el) { const msgId = el.id.replace('message-', ''); const senderName = el.dataset.senderName; const senderId = el.dataset.senderId; const text = el.dataset.text; const firstLine = text.split('\n')[0]; if(senderName && senderId && text){ replyToMessage = { messageId: msgId, senderName, senderId, text: firstLine }; document.getElementById('reply-preview-sender').textContent = `الرد على ${senderName}`; document.getElementById('reply-preview-text').textContent = firstLine; replyPreview.style.display = 'block'; messageInput.focus(); } }
        window.setReplyWrapper = (msgId) => { event.stopPropagation(); const el = document.getElementById(`message-${msgId}`); if (el) setReplyFromElement(el); };
        window.copyMessageText = async (msgId) => { const textElement = document.querySelector(`#message-${msgId} .message-text`); if (textElement) { try { await navigator.clipboard.writeText(textElement.innerText); alert("تم نسخ النص!"); } catch (err) { console.error('Failed to copy text: ', err); alert("فشل نسخ النص."); } } };
        
        window.editPublicMessage = (msgId, text) => {
            editingMessageInfo = { id: msgId, collectionPath: 'messages' };
            editMessageTextarea.value = text;
            editMessageModalEl.classList.add('show');
            editMessageTextarea.focus();
        };

        saveEditBtn.addEventListener('click', () => {
            if (!editingMessageInfo) return;
            const newText = editMessageTextarea.value.trim();
            if (newText) {
                const msgRef = doc(db, editingMessageInfo.collectionPath, editingMessageInfo.id);
                updateDoc(msgRef, {
                    text: newText,
                    isEdited: true,
                    lastEditedAt: serverTimestamp()
                });
            }
            editMessageModalEl.classList.remove('show');
            editingMessageInfo = null;
        });
        cancelEditBtn.addEventListener('click', () => {
            editMessageModalEl.classList.remove('show');
            editingMessageInfo = null;
        });

        // START: Scroll to Message Function
        window.scrollToMessage = (messageId, prefix = 'message-') => {
            const targetElement = document.getElementById(`${prefix}${messageId}`);
            if (targetElement) {
                targetElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                targetElement.classList.add('message-highlighted');
                setTimeout(() => {
                    targetElement.classList.remove('message-highlighted');
                }, 1000);
            } else {
                console.warn(`Message element with ID '${prefix}${messageId}' not found.`);
            }
        };
        // END: Scroll to Message Function

        window.toggleReaction = async (msgId, emoji) => { if (!auth.currentUser) return; const msgRef = doc(db, "messages", msgId); const msgDoc = await getDoc(msgRef); const msgData = msgDoc.data(); const uid = auth.currentUser.uid; const existing = msgData.reactions?.find(r => r.userId === uid); if (existing) { await updateDoc(msgRef, { reactions: arrayRemove(existing) }); if (existing.emoji !== emoji) { await updateDoc(msgRef, { reactions: arrayUnion({ userId: uid, emoji }) }); } } else { await updateDoc(msgRef, { reactions: arrayUnion({ userId: uid, emoji }) }); } };
        window.deleteOwnMessage = async (id) => { showCustomConfirm("هل أنت متأكد من حذف رسالتك؟", "bi bi-trash-fill", async () => await deleteDoc(doc(db, "messages", id))); };
        window.deleteOtherMessage = async (id) => { if (isVisitor || !['developer', 'admin'].includes(currentUserRole)) return; showCustomConfirm("هل أنت متأكد من حذف هذه الرسالة؟", "bi bi-trash-fill", async () => await deleteDoc(doc(db, "messages", id))); };
        window.banUser = async (uid, name) => { if (isVisitor || !['developer', 'admin'].includes(currentUserRole)) return; const userToBan = await getDoc(doc(db, "users", uid)); if (userToBan.exists() && (userToBan.data().role === 'admin' || userToBan.data().role === 'developer')) { showCustomConfirm("لا يمكنك حظر مشرف آخر.", "bi bi-shield-exclamation", () => {}); return; } showCustomConfirm(`هل أنت متأكد من حظر ${name}؟`, "bi bi-slash-circle-fill", async () => { await setDoc(doc(db, "users", uid), { isBanned: true }, { merge: true }); showCustomConfirm(`تم حظر ${name}.`, "bi bi-check-circle-fill", () => {}); })};
        window.toggleAdminRole = async (uid, name) => { if (isVisitor || currentUserRole !== 'developer') return; try { const userDocRef = doc(db, "users", uid); const userDoc = await getDoc(userDocRef); const currentRole = userDoc.exists() ? userDoc.data().role || 'user' : 'user'; const isCurrentlyAdmin = currentRole === 'admin'; const newRole = isCurrentlyAdmin ? 'user' : 'admin'; const confirmationMessage = isCurrentlyAdmin ? `هل تريد إزالة ${name} من الإشراف؟` : `هل تريد ترقية ${name} إلى مشرف؟`; showCustomConfirm(confirmationMessage, "bi bi-shield-shaded", async () => { await setDoc(userDocRef, { role: newRole }, { merge: true }); showCustomConfirm(isCurrentlyAdmin ? `تمت إزالة ${name} من الإشراف.` : `تمت ترقية ${name} إلى مشرف.`, "bi bi-person-check-fill", () => {}); }) } catch (error) { console.error("Error toggling admin role: ", error); } };
        // --- END: Public Chat Logic ---
        
        // --- START: App Lock Logic ---
        function initializeAppLock() { const lockData = getLockData(); if (!lockData.enabled) return; const lastUnlock = localStorage.getItem('app_last_unlock') || 0; const timeSinceUnlock = Date.now() - lastUnlock; if (timeSinceUnlock >= RELOCK_TIME) { appLockOverlay.style.display = 'flex'; } }
        function getLockData() { try { return JSON.parse(localStorage.getItem('app_lock_config')) || { enabled: false, passcode: null }; } catch (e) { return { enabled: false, passcode: null }; } }
        function handleUnlock() { const enteredPasscode = passcodeInput.value; const lockData = getLockData(); passcodeError.style.display = 'none'; if (enteredPasscode === lockData.passcode) { localStorage.setItem('app_last_unlock', Date.now()); appLockOverlay.style.display = 'none'; passcodeInput.value = ''; } else { passcodeError.style.display = 'block'; passcodeInput.classList.add('is-invalid'); setTimeout(() => passcodeInput.classList.remove('is-invalid'), 1000); } }
        unlockBtn.addEventListener('click', handleUnlock);
        passcodeInput.addEventListener('keyup', (event) => { if (event.key === 'Enter') handleUnlock(); });
        // --- END: App Lock Logic ---

    </script>
</body>
</html>
