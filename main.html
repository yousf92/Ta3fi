<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>الرئيسية | لا أبرح حتى أبلغ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #00a884;
            --danger-color: #ff5c5c;
            --background-color: #121212;
            --card-background: #1e1e1e;
            --text-color: #FAFAFA;
            --secondary-text-color: #CCCCCC;
            --border-color: #383838;
            --day-color: #86efac;
            --hour-color: #3b82f6;
            --minute-color: #ec4899;
            --second-color: #facc15;
            --progress-bg: rgba(0, 0, 0, 0.2);
        }
        body, html {
            margin: 0; padding: 0; font-family: 'Tajawal', sans-serif;
            background-image: url('https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=1920&q=80');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            color: var(--text-color);
            position: fixed; width: 100%; height: 100%; overflow: hidden;
        }
        .page { display: none; flex-direction: column; height: 100%; width: 100%; }
        .page.active { display: flex; }
        .home-container { display: flex; flex-direction: column; height: 100vh; }
        .content-area { flex-grow: 1; overflow-y: auto; padding: 1rem; padding-bottom: 80px; }
        .top-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 1rem; 
            background-color: rgba(18, 18, 18, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .header-icons { display: flex; gap: 1.5rem; font-size: 1.5rem; color: var(--secondary-text-color); align-items: center;}
        .header-icons i { cursor: pointer; }
        .header-icons a { color: var(--secondary-text-color); text-decoration: none; }
        .notification-icon-wrapper { position: relative; cursor: pointer; }
        .notification-badge { position: absolute; top: -2px; right: -5px; width: 10px; height: 10px; background-color: var(--danger-color); border-radius: 50%; border: 2px solid var(--background-color); display: none; }
        .welcome-message { text-align: right; }
        .welcome-message h5 { margin: 0; font-weight: 700; color: var(--text-color);}
        .welcome-message p { margin: 0; font-size: 0.9rem; color: var(--secondary-text-color); }
        .progress-timer-card { background: linear-gradient(135deg, #054238, #008069); color: white; border-radius: 20px; padding: 1.5rem; position: relative; overflow: hidden; box-shadow: 0 10px 25px rgba(0, 128, 105, 0.3); margin-bottom: 1.5rem; }
        .timer-settings-icon { position: absolute; top: 1rem; left: 1rem; background-color: rgba(255, 255, 255, 0.15); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; cursor: pointer; z-index: 10; }
        .progress-rows-container { position: relative; z-index: 5; margin-top: 2rem; }
        .progress-row { display: flex; align-items: center; background-color: var(--progress-bg); border-radius: 12px; padding: 0.7rem 1rem; margin-bottom: 0.8rem; position: relative; overflow: hidden; }
        .progress-row:last-child { margin-bottom: 0; }
        .progress-bar-fill { position: absolute; left: 0; top: 0; height: 100%; border-radius: 12px; transition: width 0.5s ease-in-out; }
        .progress-row .row-content { position: relative; z-index: 2; display: flex; width: 100%; align-items: center; justify-content: space-between; }
        .progress-row .time-label { font-weight: 700; font-size: 1rem; }
        .progress-row .time-icon { font-size: 1.2rem; }
        #days-fill { background-color: var(--day-color); }
        #hours-fill { background-color: var(--hour-color); }
        #minutes-fill { background-color: var(--minute-color); }
        #seconds-fill { background-color: var(--second-color); }
        .action-button { background-color: var(--card-background); border-radius: 15px; padding: 1rem; display: flex; justify-content: space-between; align-items: center; text-decoration: none; color: var(--text-color); box-shadow: 0 4px 15px rgba(0,0,0,0.2); margin-bottom: 1rem; font-weight: 500; border: 1px solid var(--border-color); width: 100%; }
        .action-button.najda-style { background-color: rgba(255, 92, 92, 0.1); color: var(--danger-color); border: 1px solid rgba(255, 92, 92, 0.5); justify-content: center; gap: 10px; font-size: 1.2rem; font-weight: 700; }
        .action-button.najda-style i { font-size: 1.5rem; }
        .bottom-nav { 
            display: flex; 
            justify-content: space-around; 
            padding: 0.5rem 0; 
            background-color: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 -2px 5px rgba(0,0,0,0.2); 
            position: fixed; 
            bottom: 0; 
            width: 100%; 
            z-index: 100; 
            border-top: 1px solid rgba(56, 56, 56, 0.5); 
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--secondary-text-color); text-decoration: none; font-size: 0.75rem; cursor: pointer; width: 14%; height: 50px; justify-content: center; }
        .nav-item i { font-size: 1.5rem; margin-bottom: 4px; }
        .nav-item.active { color: var(--primary-color); }
        .nav-item.special-item { transform: translateY(-20px); position: relative; } 
        .special-item .icon-background { background: linear-gradient(135deg, #00a884, #00c896); width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 10px rgba(0, 168, 132, 0.4); }
        .special-item i { color: white; font-size: 2rem; margin: 0; }
        .chat-notification-badge {
            position: absolute;
            top: -8px; 
            right: 25px; 
            background-color: var(--danger-color);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-size: 13px;
            font-weight: bold;
            display: none; 
            justify-content: center;
            align-items: center;
            border: 2px solid var(--card-background);
            z-index: 1;
        }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1050; opacity: 0; transition: opacity 0.3s ease; }
        .modal-overlay.show { display: flex; opacity: 1; }
        .modal-content-custom { background-color: var(--card-background); border-radius: 20px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); transform: scale(0.9); transition: transform 0.3s ease; width: 90%; max-width: 400px; }
        .modal-overlay.show .modal-content-custom { transform: scale(1); }
        #settings-modal-overlay { align-items: flex-end; }
        #settings-modal-content { background-color: var(--background-color); width: 100%; max-width: 800px; border-top-left-radius: 20px; border-top-right-radius: 20px; border-bottom-left-radius: 0; border-bottom-right-radius: 0; transform: translateY(100%); }
        #settings-modal-overlay.show #settings-modal-content { transform: translateY(0); }
        .modal-header-custom { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border-color); }
        .modal-header-custom h5 { margin: 0; font-weight: 700; color: #FFFFFF; }
        .modal-header-custom i { font-size: 1.2rem; cursor: pointer; color: var(--secondary-text-color); }
        .modal-body-custom { padding: 1.5rem; }
        .icon-container.yellow { background-color: #fffbe6; color: #f9c74f; }
        .icon-container.blue { background-color: #e6f7ff; color: #34b7f1; }
        .icon-container.green { background-color: #e6f9f0; color: #00a884; }
        .icon-container.red { background-color: #ffebee; color: #ff5c5c; }
        .confirm-modal-body { text-align: center; padding: 2rem 1.5rem; }
        .confirm-modal-body .confirm-icon { font-size: 4rem; color: var(--text-color); margin-bottom: 1rem; }
        .confirm-modal-body p { font-size: 1.1rem; font-weight: 500; margin-bottom: 2rem; }
        .confirm-modal-footer { display: flex; gap: 1rem; padding: 0 1.5rem 1.5rem; }
        .confirm-btn { flex: 1; padding: 0.8rem; border-radius: 12px; border: none; font-weight: 700; font-size: 1rem; cursor: pointer; }
        .confirm-btn-accept { background-color: var(--primary-color); color: white; }
        .confirm-btn-cancel { background-color: var(--danger-color); color: white; }
        #breathing-circle-container { width: 200px; height: 200px; border: 5px solid rgba(255, 255, 255, 0.7); border-radius: 50%; display: flex; justify-content: center; align-items: center; }
        #breathing-circle { width: 100%; height: 100%; background-color: white; border-radius: 50%; transform: scale(0.2); animation-duration: 19s; animation-iteration-count: infinite; animation-name: breathe; animation-timing-function: ease-in-out; }
        @keyframes breathe { 0% { transform: scale(0.2); } 21% { transform: scale(1); } 58% { transform: scale(1); } 100% { transform: scale(0.2); } }
        .notification-item { position: relative; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; margin-bottom: 10px; padding-left: 30px; }
        .notification-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .notification-title { font-weight: 700; color: #FFFFFF; }
        .notification-body { color: var(--secondary-text-color); font-size: 0.9rem; }
        .notification-date { font-size: 0.8rem; color: #aaa; }
        .delete-notification-btn { position: absolute; left: 5px; top: 50%; transform: translateY(-50%); color: var(--danger-color); cursor: pointer; font-size: 1.2rem; display: none; }
        #quote-page { 
            justify-content: center; 
            align-items: center; 
            padding: 2rem; 
            text-align: center; 
            color: white; 
            background-size: cover;
            background-position: center;
            transition: background-image 1s ease-in-out;
        }
        .quote-box { position: relative; background-color: rgba(0, 0, 0, 0.4); border: 2px solid rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-radius: 25px; padding: 4rem 2rem; width: 100%; max-width: 500px; }
        .quote-box::before, .quote-box::after { font-family: serif; font-size: 6rem; font-weight: bold; color: white; position: absolute; opacity: 0.8; }
        .quote-box::before { content: '”'; top: -1.5rem; right: 1rem; }
        .quote-box::after { content: '“'; bottom: -4.5rem; left: 1rem; }
        .top-indicator-bar { position: absolute; top: 15px; left: 50%; transform: translateX(-50%); width: 35%; max-width: 150px; height: 5px; background-color: white; border-radius: 5px; opacity: 0.7; }
        #quote-text { font-size: 1.5rem; font-weight: 700; line-height: 1.7; text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.5); }
        #close-quote-btn { position: absolute; top: 20px; left: 20px; font-size: 1.8rem; cursor: pointer; z-index: 10; text-shadow: 1px 1px 3px rgba(0,0,0,0.5); }
        .card-title { font-weight: 700; color: #FFFFFF; }
        .modal-title { color: #FFFFFF; }
        #notifications-modal .modal-content { background-color: var(--background-color); color: var(--text-color); }
        #notifications-modal .modal-header { border-bottom: 1px solid var(--border-color); }
        #notifications-modal .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }
        .action-button.najda-style .bi-fire { animation: fire-flicker 1.5s ease-in-out infinite alternate; position: relative; top: 3px; }
        @keyframes fire-flicker { 0% { transform: scale(1.0) translateY(0) rotate(0); color: #ffad00; text-shadow: 0 0 4px #ff5c5c, 0 0 8px #ff5c5c, 0 0 12px #ffad00; } 25% { transform: scale(1.1) translateY(-2px) rotate(3deg); color: #facc15; text-shadow: 0 0 6px #ff5c5c, 0 0 10px #ff5c5c, 0 0 16px #facc15; } 50% { transform: scale(0.95) translateY(1px) rotate(-2deg); color: var(--danger-color); text-shadow: 0 0 4px #ff5c5c, 0 0 8px #ff5c5c, 0 0 12px #ffad00; } 75% { transform: scale(1.05) translateY(-1px) rotate(2deg); color: #facc15; text-shadow: 0 0 6px #ff5c5c, 0 0 12px #ff5c5c, 0 0 18px #facc15; } 100% { transform: scale(1.0) translateY(0) rotate(0); color: #ffad00; text-shadow: 0 0 4px #ff5c5c, 0 0 8px #ff5c5c, 0 0 12px #ffad00; } }
        .fire-alarm { width: 28px; height: 24px; position: relative; }
        .fire-alarm-dome { width: 100%; height: 20px; position: absolute; top: 0; left: 0; background: radial-gradient(circle at 50% 0%, #ff8a8a, #d10000 90%); border-radius: 14px 14px 3px 3px; overflow: hidden; z-index: 2; border: 1px solid #ff5c5c; }
        .fire-alarm-dome::before { content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-image: repeating-linear-gradient(to bottom, rgba(255, 255, 255, 0.15) 0px, rgba(255, 255, 255, 0.15) 1px, transparent 1px, transparent 3px); z-index: 3; }
        .fire-alarm-dome::after { content: ''; position: absolute; top: 50%; left: 50%; width: 200%; height: 200%; background: radial-gradient(circle, rgba(255,220,150,0.9) 0%, rgba(255,100,100,0) 35%); border-radius: 50%; transform: translate(-50%, -50%); animation: beacon-flash 1.2s infinite ease-in-out; z-index: 4; }
        .fire-alarm-base { width: 28px; height: 5px; background: linear-gradient(to top, #c00000, #e02020); position: absolute; bottom: 0; left: 0; border-radius: 0 0 4px 4px; z-index: 1; box-shadow: 0 2px 3px rgba(0,0,0,0.5); }
        @keyframes beacon-flash { 0%, 100% { opacity: 0.4; transform: translate(-50%, -50%) scale(0.5); } 50% { opacity: 1; transform: translate(-50%, -50%) scale(1); } }
        
        .video-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            z-index: 1;
            border-radius: 20px; 
            transition: opacity 0.5s ease-in-out;
            opacity: 0;
        }
        .video-background.visible {
            opacity: 1;
        }
        .video-background-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.45); 
            z-index: 2;
            border-radius: 20px; 
            display: none; 
            transition: opacity 0.5s ease-in-out;
        }
         .video-background-overlay.visible {
            display: block;
        }
        #app-lock-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(18, 18, 18, 0.95);
            z-index: 2000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(10px);
        }
        .lock-container {
            text-align: center;
            padding: 2rem;
            background-color: var(--card-background);
            border-radius: 15px;
            border: 1px solid var(--border-color);
        }
        .lock-container .icon {
            font-size: 4rem;
            color: var(--primary-color);
            margin-bottom: 1rem;
        }
        #passcode-input {
            max-width: 200px;
            margin: 1.5rem auto;
            letter-spacing: 1.5rem;
            font-size: 1.5rem;
            text-align: center;
            direction: ltr;
        }
        #passcode-input::placeholder {
            letter-spacing: normal;
        }
        #unlock-btn {
            width: 100%;
            max-width: 200px;
        }
        #passcode-error {
            display: none;
            color: var(--danger-color);
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        #ai-advice-card {
            position: relative;
            background-size: cover;
            background-position: center;
            border-radius: 15px;
            border: 1px solid var(--border-color);
            padding: 1.5rem;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            color: white;
            overflow: hidden;
            transition: background-image 0.5s ease-in-out;
            margin-top: 1rem;
        }
        #ai-advice-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            z-index: 1;
        }
        #ai-advice-content {
            position: relative;
            z-index: 2;
        }
        #ai-advice-text {
            font-size: 1.1rem;
            font-weight: 500;
            line-height: 1.8;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }
        #ai-advice-refresh-btn {
            position: absolute;
            top: 1rem;
            left: 1rem;
            z-index: 3;
            font-size: 1.4rem;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.3s ease, background-color 0.3s ease;
        }
        #ai-advice-refresh-btn:hover {
            transform: rotate(90deg);
            background-color: rgba(255, 255, 255, 0.2);
        }
        .spinner-grow-sm {
            width: 1rem;
            height: 1rem;
        }

        /* --- START: New Styles for Inspiration Display --- */
        #inspiration-display {
            position: relative;
            background-size: cover;
            background-position: center;
            color: white;
            overflow: hidden;
            transition: background-image 0.5s ease-in-out;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 150px; /* Give it some height */
        }
        #inspiration-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5); /* Dark overlay */
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            z-index: 1;
            border-radius: 15px; /* Match parent border-radius */
        }
        #inspiration-text {
            position: relative;
            z-index: 2; /* Text above overlay */
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.7);
        }
        /* --- END: New Styles for Inspiration Display --- */
    </style>
</head>
<body style="visibility: hidden;">
    <div id="app-lock-overlay">
        <div class="lock-container">
            <i class="bi bi-shield-lock-fill icon"></i>
            <h5>التطبيق مقفل</h5>
            <p class="text-secondary small">أدخل رمز المرور للمتابعة</p>
            <input type="password" inputmode="numeric" pattern="[0-9]*" maxlength="4" class="form-control" id="passcode-input" placeholder="----">
            <div id="passcode-error">رمز المرور غير صحيح</div>
            <button id="unlock-btn" class="btn btn-primary mt-2">فتح القفل</button>
        </div>
    </div>

    <div id="home-page" class="page active">
        <div class="home-container">
            <header class="top-header">
                <div class="header-icons">
                    <div class="notification-icon-wrapper" data-bs-toggle="modal" data-bs-target="#notifications-modal">
                        <i class="bi bi-bell-fill"></i>
                        <span class="notification-badge"></span>
                    </div>
                    <a href="settings.html"><i class="bi bi-person-circle"></i></a>
                </div>
                <div class="welcome-message">
                    <h5 id="welcome-user"></h5>
                    <p id="current-date"></p>
                </div>
            </header>
            <main class="content-area">
                <div class="progress-timer-card">
                    <div class="video-background-overlay"></div>
                    <video autoplay muted loop playsinline class="video-background" id="counter-video-bg"></video>
                    <div class="timer-settings-icon d-none"><i class="bi bi-gear-fill"></i></div>
                    <div class="progress-rows-container">
                        <div class="progress-row">
                            <div class="progress-bar-fill" id="days-fill"></div>
                            <div class="row-content">
                                <span class="time-label"><span id="days-value">0</span> أيام</span>
                                <i class="bi bi-calendar-check-fill time-icon"></i>
                            </div>
                        </div>
                        <div class="progress-row">
                            <div class="progress-bar-fill" id="hours-fill"></div>
                            <div class="row-content">
                                <span class="time-label"><span id="hours-value">0</span> ساعات</span>
                                <i class="bi bi-clock-fill time-icon"></i>
                            </div>
                        </div>
                        <div class="progress-row">
                            <div class="progress-bar-fill" id="minutes-fill"></div>
                            <div class="row-content">
                                <span class="time-label"><span id="minutes-value">0</span> دقائق</span>
                                <i class="bi bi-clock-history time-icon"></i>
                            </div>
                        </div>
                        <div class="progress-row">
                            <div class="progress-bar-fill" id="seconds-fill"></div>
                            <div class="row-content">
                                <span class="time-label"><span id="seconds-value">0</span> ثواني</span>
                                <i class="bi bi-hourglass-split time-icon"></i>
                            </div>
                        </div>
                    </div>
                </div>
                 <div id="inspiration-container" class="mb-3">
                    <button id="inspiration-btn" class="action-button" style="justify-content: center; text-align: center; gap: 10px; font-weight: 700; width: 100%;">
                        <span>🔥عندي رغبة شديدة،أعطني حلا جذريا🔥</span>
                    </button>
                    <div id="inspiration-display" class="p-3 mt-2 d-none" style="background-color: var(--card-background); border-radius: 15px; border: 1px solid var(--border-color);">
                        <p id="inspiration-text" class="mb-0"></p>
                    </div>
                </div>
                <button id="start-timer-btn" class="btn btn-success btn-lg w-100 mb-3 d-none">بدء العداد</button>
                <button id="najda-button" class="action-button najda-style">
                    <i class="bi bi-fire"></i>
                    <span>النجدة!</span>
                    <div class="fire-alarm">
                        <div class="fire-alarm-dome"></div>
                        <div class="fire-alarm-base"></div>
                    </div>
                </button>

            </main>
            <nav class="bottom-nav">
                <a href="main.html" class="nav-item active"><i class="bi bi-house-door-fill"></i><span>الرئيسية</span></a>
                <a href="diaries.html" class="nav-item"><i class="bi bi-book-fill"></i><span>اليوميات</span></a>
                <a href="articles.html" class="nav-item"><i class="bi bi-award-fill"></i><span>المقالات</span></a>
                <a href="chat.html" class="nav-item special-item">
                    <div class="icon-background"><i class="bi bi-chat-dots-fill"></i></div>
                    <span>دردشة</span>
                    <span class="chat-notification-badge"></span>
                </a>
                <a href="follow-up.html" class="nav-item"><i class="bi bi-signpost-split-fill"></i><span>المتابعة</span></a>
                <a href="library.html" class="nav-item"><i class="bi bi-collection-fill"></i><span>المكتبة</span></a>
                <a href="settings.html" class="nav-item"><i class="bi bi-gear-fill"></i><span>الاعدادات</span></a>
            </nav>
        </div>
    </div>
    
    <div id="breathing-page" class="page" style="background: linear-gradient(to top, #28b485, #7ed56f); justify-content: center; align-items: center; text-align: center; color: white; padding: 1rem;">
        <i class="bi bi-x-lg" id="close-breathing-btn" style="position: absolute; top: 20px; right: 20px; font-size: 1.8rem; cursor: pointer; z-index: 10;"></i>
        <div id="breathing-circle-container"><div id="breathing-circle"></div></div>
        <h1 id="breathing-text" style="font-size: 4rem; margin-top: 2rem; font-weight: 700; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">شهيق</h1>
        <div id="breathing-timer" style="font-size: 1.5rem; color: white; margin-top: 1rem; font-weight: bold;"></div>
        <button id="skip-to-quote-btn" class="btn btn-outline-light mt-4">الانتقال إلى الاقتباس <i class="bi bi-arrow-left-short"></i></button>
        <p style="font-size: 1.1rem; max-width: 300px; margin-top: 1.5rem;">خذ دقيقة من وقتك للتنفس حيث يساعدك على تهدئة عقلك</p>
    </div>

    <div id="quote-page" class="page">
        <div class="top-indicator-bar"></div>
        <i class="bi bi-x-lg" id="close-quote-btn"></i>
        <div class="quote-box">
            <p id="quote-text"></p>
        </div>
    </div>

    <div class="modal-overlay" id="settings-modal-overlay">
        <div class="modal-content-custom" id="settings-modal-content">
            <header class="modal-header-custom"><h5>اعدادات العداد</h5><i class="bi bi-x-lg" id="close-settings-button"></i></header>
            <div class="modal-body-custom">
                <button class="action-button" id="reset-timer-button"><span>تصفير العداد</span><div class="icon-container yellow"><i class="bi bi-arrow-counterclockwise"></i></div></button>
                <button class="action-button" id="set-date-button"><span>تعيين تاريخ بداية جديد</span><div class="icon-container blue"><i class="bi bi-calendar-plus-fill"></i></div></button>
                <div id="developer-video-options" class="d-none">
                    <button class="action-button" id="set-video-button">
                        <span>تعيين خلفية فيديو</span>
                        <div class="icon-container green"><i class="bi bi-camera-video-fill"></i></div>
                    </button>
                    <button class="action-button" id="remove-video-button">
                        <span>إزالة خلفية الفيديو</span>
                        <div class="icon-container red"><i class="bi bi-trash-fill"></i></div>
                    </button>
                </div>
                <input type="datetime-local" id="date-time-picker" style="opacity: 0; position: absolute; left: -9999px; width: 1px; height: 1px;">
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="confirm-reset-modal">
        <div class="modal-content-custom">
            <div class="confirm-modal-body"><div class="confirm-icon"><i class="bi bi-arrow-counterclockwise"></i></div><p>هل أنت متأكد من تصفير العداد؟</p></div>
            <div class="confirm-modal-footer"><button class="confirm-btn confirm-btn-cancel" id="cancel-reset-button">رجوع</button><button class="confirm-btn confirm-btn-accept" id="confirm-reset-action-button">تصفير</button></div>
        </div>
    </div>

    <div class="modal fade" id="notifications-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">الإشعارات</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="notifications-list"></div>
                <div class="modal-footer">
                    <button id="open-send-modal-btn" type="button" class="btn btn-success d-none" data-bs-toggle="modal" data-bs-target="#send-notification-modal">إرسال إشعار جديد</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="send-notification-modal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إرسال إشعار جديد</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="notification-title" class="form-label">العنوان</label>
                        <input type="text" class="form-control" id="notification-title" placeholder="عنوان الإشعار">
                    </div>
                    <div class="mb-3">
                        <label for="notification-message" class="form-label">الرسالة</label>
                        <textarea class="form-control" id="notification-message" rows="4" placeholder="محتوى الإشعار"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-close" data-bs-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-primary" id="send-notification-btn">إرسال</button>
                </div>
            </div>
        </div>
    </div>
    
    <input type="file" accept="video/*" id="video-file-picker" style="display: none;">

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, query, where, orderBy, onSnapshot, serverTimestamp, getDocs, arrayUnion, updateDoc, deleteDoc, limit, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAGgZmhJ_mMezlf7xElisvzJ8l9D758d4g",
            authDomain: "my-chat-app-daaf8.firebaseapp.com",
            projectId: "my-chat-app-daaf8",
            storageBucket: "my-chat-app-daaf8.firebasestorage.app",
            messagingSenderId: "789086064752",
            appId: "1:789086064752:web:d081f1b6832dabca1d64b5"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        function initializeGlobalChatNotifications(userId) {
            const chatBadge = document.querySelector('.chat-notification-badge');
            if (!chatBadge) return;

            let publicUnreadCount = 0;
            let privateUnreadCount = 0;
            let publicListenerUnsubscribe = null;
            let privateListenerUnsubscribe = null;

            function updateBadge() {
                const totalUnread = publicUnreadCount + privateUnreadCount;
                if (totalUnread > 0) {
                    chatBadge.textContent = totalUnread > 99 ? '99+' : totalUnread;
                    chatBadge.style.display = 'flex';
                } else {
                    chatBadge.style.display = 'none';
                }
            }

            if (window.publicListenerUnsubscribe) window.publicListenerUnsubscribe();
            if (window.privateListenerUnsubscribe) window.privateListenerUnsubscribe();

            const lastReadTimestamp = parseInt(localStorage.getItem('lastReadTimestamp') || '0');
            const messagesRef = collection(db, "messages");
            const publicQuery = query(messagesRef, where("createdAt", ">", Timestamp.fromMillis(lastReadTimestamp)));
            window.publicListenerUnsubscribe = onSnapshot(publicQuery, (snapshot) => {
                let count = 0;
                snapshot.forEach(doc => {
                    if (doc.data().senderId !== userId) {
                        count++;
                    }
                });
                publicUnreadCount = count;
                updateBadge();
            });

            const userIsAnonymous = auth.currentUser ? auth.currentUser.isAnonymous : true;
            if (!userIsAnonymous) {
                const privateChatsQuery = query(collection(db, "private_chats"), where("participants", "array-contains", userId));
                window.privateListenerUnsubscribe = onSnapshot(privateChatsQuery, (snapshot) => {
                    let count = 0;
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (!data[`hidden_for_${userId}`]) {
                            count += (data[`unread_count_${userId}`] || 0);
                        }
                    });
                    privateUnreadCount = count;
                    updateBadge();
                });
            } else {
                 privateUnreadCount = 0;
                 updateBadge();
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            let startTime = null;
            let timerInterval = null;
            let currentUserRole = 'user';
            let breathingTimeouts = [];
            let countdownInterval = null;
            let remainingTime = 0;
            let previousSolutions = [];
            const welcomeUserEl = document.getElementById('welcome-user');
            const openSendModalBtn = document.getElementById('open-send-modal-btn');
            const startTimerBtn = document.getElementById('start-timer-btn');
            const timerSettingsIcon = document.querySelector('.timer-settings-icon');
            const notificationBadge = document.querySelector('.notification-badge');
            const notificationsModalEl = document.getElementById('notifications-modal');
            let latestNotificationTimestamp = null;
            const natureImages = [
                'https://images.unsplash.com/photo-1506905925346-21bda4d32df4?w=800&q=80',
                'https://images.unsplash.com/photo-1488866022504-f2584929ca5f?w=800&q=80',
                'https://images.unsplash.com/photo-1542314831-068cd1dbb563?w=800&q=80',
                'https://images.unsplash.com/photo-1507525428034-b723a996f6ea?w=800&q=80'
            ];
            let lastImageIndex = -1;

            const appLockOverlay = document.getElementById('app-lock-overlay');
            const passcodeError = document.getElementById('passcode-error');
            const unlockBtn = document.getElementById('unlock-btn');
            const passcodeInput = document.getElementById('passcode-input');
            const RELOCK_TIME = 3 * 60 * 1000;

            function getLockData() {
                try {
                    return JSON.parse(localStorage.getItem('app_lock_config')) || { enabled: false, passcode: null };
                } catch (e) {
                    return { enabled: false, passcode: null };
                }
            }
            
            function syncLockState() {
            }

            function initializeAppLock() {
                syncLockState();
                const lockData = getLockData();
                if (!lockData.enabled) return;
                
                const lastUnlock = localStorage.getItem('app_last_unlock') || 0;
                const timeSinceUnlock = Date.now() - lastUnlock;

                if (timeSinceUnlock >= RELOCK_TIME) {
                    appLockOverlay.style.display = 'flex';
                }
            }

            function handleUnlock() {
                const enteredPasscode = passcodeInput.value;
                const lockData = getLockData();
                passcodeError.style.display = 'none';
                if (enteredPasscode === lockData.passcode) {
                    localStorage.setItem('app_last_unlock', Date.now());
                    appLockOverlay.style.display = 'none';
                    passcodeInput.value = '';
                } else {
                    passcodeError.style.display = 'block';
                    passcodeInput.classList.add('is-invalid');
                    setTimeout(() => passcodeInput.classList.remove('is-invalid'), 1000);
                }
            }

            unlockBtn.addEventListener('click', handleUnlock);
            passcodeInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') handleUnlock();
            });
            window.addEventListener('storage', syncLockState);

            function callGeminiAPI(prompt) {
                return new Promise((resolve, reject) => {
                    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyYn_lPlFg25E8QTJQGie4ams49eYQekl-qZ9mm9oB4BkLyBtuTS2ZX9pw6D5mfj1Io/exec";
                    
                    const callbackName = 'jsonp_callback_' + Math.round(100000 * Math.random());

                    window[callbackName] = function(data) {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        if (data.error) {
                            console.error("Error from Apps Script:", data.error);
                            resolve("عفوًا، حدثت مشكلة مؤقتة. يرجى المحاولة مرة أخرى لاحقًا.");
                        } else {
                            resolve(data.text);
                        }
                    };

                    const script = document.createElement('script');
                    script.src = WEB_APP_URL + '?callback=' + callbackName + '&prompt=' + encodeURIComponent(prompt);
                    
                    script.onerror = function() {
                        delete window[callbackName];
                        document.body.removeChild(script);
                        resolve("حدثت مشكلة في الاتصال بالشبكة.");
                    };

                    document.body.appendChild(script);
                });
            }

            function setupGeminiFeatures() {
                const inspirationBtn = document.getElementById('inspiration-btn');
                
                inspirationBtn.addEventListener('click', async () => {
                    const inspirationDisplay = document.getElementById('inspiration-display');
                    const inspirationText = document.getElementById('inspiration-text');
                    inspirationBtn.disabled = true;
                    inspirationBtn.innerHTML = `<span>لحظة أفكر لك بحل... <i class="bi bi-hourglass-split"></i></span>`;
                    
                    let basePrompt = `
                        أنا عندي رغبة قوية مرة إني أشوف مقاطع إباحية وأبغى حل جذري وفوري.
                        بصفتك ناصح أمين وفاهم على منهج السلف الصالح، عطني نصيحة عملية ومباشرة أقدر أسويها الحين عشان أتجاوز هذي الرغبة.

                        التزم بالقواعد التالية بدقة:
                        1.  **اللهجة:** تكلم باللهجة السعودية العامية (نجدية أو حجازية).
                        2.  **الأسلوب:** خل كلامك طبيعي كأنك تسولف مع خويك، مو كأنك آلة.
                        3.  **التنسيق:** لا تستخدم أي تشكيل (فتحة، ضمة، كسرة) ولا أي علامات ترقيم (لا فاصلة ولا نقطة).
                        4.  **الطول:** عطني جمل قصيرة ومختصرة.
                        5.  **التنوع:** إذا قلت لك 'أبغى حل ثاني'، عطني حل جديد ومختلف تماماً. لا تكرر نفس الكلام.
                    `;
                    
                    if (previousSolutions.length > 0) {
                        const previousSolutionsText = previousSolutions.join(' و ');
                        basePrompt += `\nالحلول اللي عطيتني إياها قبل هي: ${previousSolutionsText}. لا تكررها وعطني شي جديد.`;
                    }

                    const generatedText = await callGeminiAPI(basePrompt);
                    
                    if (generatedText && !generatedText.includes('خطأ')) {
                         previousSolutions.push(generatedText);
                    }
                    
                    let newImageIndex;
                    do {
                        newImageIndex = Math.floor(Math.random() * natureImages.length);
                    } while (newImageIndex === lastImageIndex && natureImages.length > 1);
                    lastImageIndex = newImageIndex; 
                    inspirationDisplay.style.backgroundImage = `url('${natureImages[newImageIndex]}')`;
                    inspirationDisplay.style.backgroundColor = 'transparent';


                    inspirationText.innerHTML = generatedText.replace(/\n/g, '<br>');
                    inspirationDisplay.classList.remove('d-none');
                    inspirationBtn.disabled = false;
                    inspirationBtn.innerHTML = `<span>🔥 أبغى حل ثاني</span>`;
                });
            }

            function setupAiAdviceFeature() {
                const adviceCard = document.getElementById('ai-advice-card');
                const adviceTextEl = document.getElementById('ai-advice-text');
                const refreshBtn = document.getElementById('ai-advice-refresh-btn');
                let isGenerating = false;
                let previousAdvice = [];

                async function generateAiAdvice() {
                    if (isGenerating) return;
                    isGenerating = true;
                    
                    adviceTextEl.innerHTML = '<div class="spinner-grow text-light spinner-grow-sm" role="status"><span class="visually-hidden">Loading...</span></div>';
                    
                    let prompt = `
                        أنشئ نصيحة موجزة فريدة من نوعها باللهجة السعودية العامية وبدون أي حركات (تشكيل).
                        
                        **القاعدة الأولى والأهم:** يجب أن تبدأ النصيحة **دائماً** بالجملة التالية: "إذا تركت الإدمان، فإن..."
                        
                        بعد هذه الجملة، أكمل النصيحة بحيث تكون موجهة خصيصًا لشخص يعاني من إدمان الإباحية والعادة السرية.
                        التركيز الأساسي للنصيحة يجب أن يكون على الجوانب الإيجابية التالية:
                        1.  **السعادة المستقبلية:** صف الفرح والراحة النفسية وجمال الحياة التي تنتظره بعد تركه للإدمان.
                        2.  **الرضا الإلهي:** أشر إلى رضا الله عز وجل الذي سيناله بتركه لهذه العادة.
                        اجعل النصيحة تبدو وكأنها صادرة من صديق حقيقي وداعم، وليس من ذكاء اصطناعي.
                        لا تستخدم أي علامات ترقيم، واجعلها من سطرين فقط بعد الجملة الافتتاحية.
                    `;

                    if (previousAdvice.length > 0) {
                        const previousAdviceText = previousAdvice.join(' - ');
                        prompt += `\n\nالنصائح السابقة التي قدمتها هي: "${previousAdviceText}". يمنع منعاً باتاً تكرار أي فكرة أو عبارة منها. قدم نصيحة جديدة ومختلفة تماماً.`;
                    }

                    const advice = await callGeminiAPI(prompt);
                    
                    if (advice && !advice.includes('خطأ')) {
                        previousAdvice.push(advice);
                         if (previousAdvice.length > 15) {
                            previousAdvice.shift();
                        }
                    }

                    adviceTextEl.innerHTML = advice.replace(/\n/g, '<br>');

                    let newImageIndex;
                    do {
                        newImageIndex = Math.floor(Math.random() * natureImages.length);
                    } while (newImageIndex === lastImageIndex && natureImages.length > 1);
                    lastImageIndex = newImageIndex;
                    adviceCard.style.backgroundImage = `url('${natureImages[newImageIndex]}')`;
                    
                    isGenerating = false;
                }

                refreshBtn.addEventListener('click', generateAiAdvice);
                generateAiAdvice();
            }

            onAuthStateChanged(auth, async (user) => {
                if (user && (user.emailVerified || user.isAnonymous)) {
                    // إذا كان المستخدم مسجلاً، أظهر الصفحة الرئيسية
                    document.body.style.visibility = 'visible';
                    
                    initializeAppLock();

                    setInterval(() => {
                        if (document.visibilityState === 'visible') {
                            localStorage.setItem('app_last_unlock', Date.now());
                        }
                    }, 60 * 1000); 

                    document.addEventListener('visibilitychange', () => {
                        if (document.visibilityState === 'visible') {
                            initializeAppLock();
                        }
                    });
                    
                    initializeGlobalChatNotifications(user.uid);
                    listenForBackgroundVideoChanges();

                    if (user.isAnonymous) {
                        welcomeUserEl.textContent = `مرحبا ٲيها الزائر`;
                        openSendModalBtn.classList.add('d-none');
                        const visitorTimerStart = localStorage.getItem('visitorTimerStart');
                        if (visitorTimerStart) {
                            startTime = new Date(parseInt(visitorTimerStart));
                            startTimerBtn.classList.add('d-none');
                            timerSettingsIcon.classList.remove('d-none');
                            updateTimer();
                            if(timerInterval) clearInterval(timerInterval);
                            timerInterval = setInterval(updateTimer, 1000);
                        } else {
                            startTimerBtn.classList.remove('d-none');
                            timerSettingsIcon.classList.add('d-none');
                            updateTimerDisplay(0, 0, 0, 0);
                        }
                        loadNotifications(null);
                    } else {
                        welcomeUserEl.textContent = `مرحبا ${user.displayName || 'المستخدم'}`;
                        const userDocRef = doc(db, "users", user.uid);
                        const userDoc = await getDoc(userDocRef);
                        if (userDoc.exists()) {
                            currentUserRole = userDoc.data().role || 'user';
                            if (currentUserRole === 'developer') { 
                                openSendModalBtn.classList.remove('d-none'); 
                                document.getElementById('developer-video-options').classList.remove('d-none');
                            }
                            if (userDoc.data().timerStartDate) {
                                startTime = userDoc.data().timerStartDate.toDate();
                                startTimerBtn.classList.add('d-none'); 
                                timerSettingsIcon.classList.remove('d-none'); 
                                updateTimer();
                                if (timerInterval) clearInterval(timerInterval);
                                timerInterval = setInterval(updateTimer, 1000);
                            } else {
                                startTimerBtn.classList.remove('d-none'); 
                                timerSettingsIcon.classList.add('d-none'); 
                                updateTimerDisplay(0,0,0,0); 
                            }
                        } else {
                            await setDoc(userDocRef, { role: 'user', lastSeenNotificationTimestamp: new Date(0) }, { merge: true });
                            startTimerBtn.classList.remove('d-none');
                            timerSettingsIcon.classList.add('d-none');
                            updateTimerDisplay(0,0,0,0);
                        }
                        loadNotifications(user.uid);
                    }
                } else {
                    // إذا لم يكن مسجلاً، انقله إلى صفحة تسجيل الدخول
                    window.location.href = 'index.html';
                }
            });

            startTimerBtn.addEventListener('click', async () => {
                const user = auth.currentUser;
                startTime = new Date();
                if (user && !user.isAnonymous) {
                    const userDocRef = doc(db, "users", user.uid);
                    await setDoc(userDocRef, { timerStartDate: startTime }, { merge: true });
                } else {
                    localStorage.setItem('visitorTimerStart', startTime.getTime());
                }
                startTimerBtn.classList.add('d-none');
                timerSettingsIcon.classList.remove('d-none');
                updateTimer();
                if (timerInterval) clearInterval(timerInterval);
                timerInterval = setInterval(updateTimer, 1000);
            });

            async function loadNotifications(userId) {
                const notificationsList = document.getElementById('notifications-list');
                let lastSeenTimestamp = new Date(0);

                if (userId) {
                    const userDocRef = doc(db, "users", userId);
                    const userDoc = await getDoc(userDocRef);
                    lastSeenTimestamp = userDoc.data()?.lastSeenNotificationTimestamp?.toDate() || new Date(0);
                }

                const q = query(collection(db, "notifications"), orderBy("createdAt", "desc"));
                onSnapshot(q, (snapshot) => {
                    notificationsList.innerHTML = "";
                    if (snapshot.empty) {
                        notificationsList.innerHTML = '<p class="text-center text-muted">لا توجد إشعارات حالياً.</p>';
                        notificationBadge.style.display = 'none';
                        return;
                    }

                    if (userId) {
                        const firstDoc = snapshot.docs[0];
                        latestNotificationTimestamp = firstDoc.data().createdAt?.toDate();
                        if (latestNotificationTimestamp && latestNotificationTimestamp > lastSeenTimestamp) {
                            notificationBadge.style.display = 'block';
                        } else {
                            notificationBadge.style.display = 'none';
                        }
                    } else {
                         notificationBadge.style.display = 'none';
                    }

                    snapshot.forEach(docSnapshot => {
                        const notification = docSnapshot.data();
                        const date = notification.createdAt?.toDate().toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' }) || '';
                        const item = document.createElement('div');
                        item.className = 'notification-item';
                        let deleteIconHTML = '';
                        if (currentUserRole === 'developer' && userId) {
                            deleteIconHTML = `<i class="bi bi-trash delete-notification-btn" data-id="${docSnapshot.id}" style="display: inline-block;"></i>`;
                        }
                        item.innerHTML = `${deleteIconHTML}<div class="d-flex justify-content-between align-items-center"><h6 class="notification-title mb-1">${notification.title}</h6><span class="notification-date">${date}</span></div><p class="notification-body mb-0">${notification.message}</p>`;
                        notificationsList.appendChild(item);
                    });

                    if (currentUserRole === 'developer' && userId) {
                        document.querySelectorAll('.delete-notification-btn').forEach(button => {
                            button.addEventListener('click', async (e) => {
                                e.stopPropagation();
                                const notifId = e.target.getAttribute('data-id');
                                if (confirm('هل أنت متأكد من حذف هذا الإشعار؟')) {
                                    try { await deleteDoc(doc(db, "notifications", notifId)); } catch (error) { console.error("Error deleting notification: ", error); alert('حدث خطأ أثناء حذف الإشعار.'); }
                                }
                            });
                        });
                    }
                });
            }

            notificationsModalEl.addEventListener('show.bs.modal', async () => {
                const user = auth.currentUser;
                if (user && !user.isAnonymous && latestNotificationTimestamp) {
                    notificationBadge.style.display = 'none';
                    const userDocRef = doc(db, "users", user.uid);
                    try { await updateDoc(userDocRef, { lastSeenNotificationTimestamp: latestNotificationTimestamp }); } catch (error) { console.error("Error updating last seen timestamp: ", error); }
                }
            });
            
            const sendNotificationBtn = document.getElementById('send-notification-btn');
            const sendNotificationModal = new bootstrap.Modal(document.getElementById('send-notification-modal'));
            sendNotificationBtn.addEventListener('click', async () => {
                const title = document.getElementById('notification-title').value.trim();
                const message = document.getElementById('notification-message').value.trim();
                if (!title || !message) { alert('الرجاء ملء جميع الحقول.'); return; }
                try {
                    await addDoc(collection(db, "notifications"), { title: title, message: message, createdAt: serverTimestamp() });
                    alert('تم إرسال الإشعار بنجاح.');
                    document.getElementById('notification-title').value = '';
                    document.getElementById('notification-message').value = '';
                    sendNotificationModal.hide();
                } catch (error) { console.error("Error sending notification: ", error); alert('حدث خطأ أثناء إرسال الإشعار.'); }
            });

            const dateElement = document.getElementById('current-date');
            const daysValueEl = document.getElementById('days-value');
            const hoursValueEl = document.getElementById('hours-value');
            const minutesValueEl = document.getElementById('minutes-value');
            const secondsValueEl = document.getElementById('seconds-value');
            const daysFillEl = document.getElementById('days-fill');
            const hoursFillEl = document.getElementById('hours-fill');
            const minutesFillEl = document.getElementById('minutes-fill');
            const secondsFillEl = document.getElementById('seconds-fill');

            function updateLiveDate() {
                const today = new Date();
                const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                dateElement.textContent = today.toLocaleDateString('ar-EG', options);
            }
            updateLiveDate();

            function updateTimerDisplay(d, h, m, s) {
                daysValueEl.textContent = d; hoursValueEl.textContent = h; minutesValueEl.textContent = m; secondsValueEl.textContent = s;
                const daysPercent = d > 0 ? ((d % 30) / 29) * 100 : 0;
                const hoursPercent = h > 0 ? (h / 23) * 100 : 0;
                const minutesPercent = m > 0 ? (m / 59) * 100 : 0;
                const secondsPercent = s > 0 ? (s / 59) * 100 : 0;
                daysFillEl.style.width = `${Math.min(daysPercent, 100)}%`;
                hoursFillEl.style.width = `${Math.min(hoursPercent, 100)}%`;
                minutesFillEl.style.width = `${Math.min(minutesPercent, 100)}%`;
                secondsFillEl.style.width = `${Math.min(secondsPercent, 100)}%`;
            }

            function updateTimer() {
                if (!startTime) { updateTimerDisplay(0,0,0,0); return; };
                const now = new Date();
                const difference = now - startTime;
                if (difference < 0) { updateTimerDisplay(0,0,0,0); return; }
                const days = Math.floor(difference / (1000 * 60 * 60 * 24));
                const hours = Math.floor((difference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const minutes = Math.floor((difference % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((difference % (1000 * 60)) / 1000);
                updateTimerDisplay(days, hours, minutes, seconds);
            }

            const settingsIcon = document.querySelector('.timer-settings-icon');
            const settingsModalOverlay = document.getElementById('settings-modal-overlay');
            const closeSettingsButton = document.getElementById('close-settings-button');
            const resetTimerButton = document.getElementById('reset-timer-button');
            const setDateButton = document.getElementById('set-date-button');
            const dateTimePicker = document.getElementById('date-time-picker');
            const confirmResetModal = document.getElementById('confirm-reset-modal');
            const cancelResetButton = document.getElementById('cancel-reset-button');
            const confirmResetActionButton = document.getElementById('confirm-reset-action-button');

            settingsIcon.addEventListener('click', () => settingsModalOverlay.classList.add('show'));
            const closeSettingsModal = () => settingsModalOverlay.classList.remove('show');
            closeSettingsButton.addEventListener('click', closeSettingsModal);
            settingsModalOverlay.addEventListener('click', (e) => { if (e.target === settingsModalOverlay) closeSettingsModal(); });
            setDateButton.addEventListener('click', () => dateTimePicker.showPicker());
            
            dateTimePicker.addEventListener('change', async (e) => {
                const user = auth.currentUser;
                if (!e.target.value) return;

                const newStartTime = new Date(e.target.value);
                if (isNaN(newStartTime.getTime())) return;

                if (user && !user.isAnonymous) {
                    const userDocRef = doc(db, "users", user.uid);
                    await setDoc(userDocRef, { timerStartDate: newStartTime }, { merge: true });
                } else {
                     localStorage.setItem('visitorTimerStart', newStartTime.getTime());
                }
                location.reload();
            });

            resetTimerButton.addEventListener('click', () => { closeSettingsModal(); setTimeout(() => confirmResetModal.classList.add('show'), 300); });
            const closeConfirmModal = () => confirmResetModal.classList.remove('show');
            cancelResetButton.addEventListener('click', closeConfirmModal);
            confirmResetModal.addEventListener('click', (e) => { if (e.target === confirmResetModal) closeConfirmModal(); });
            
            confirmResetActionButton.addEventListener('click', async () => {
                const user = auth.currentUser;
                const newStartTime = new Date();
                if (user && !user.isAnonymous) {
                    const userDocRef = doc(db, "users", user.uid);
                    await setDoc(userDocRef, { timerStartDate: newStartTime }, { merge: true });
                } else {
                    localStorage.setItem('visitorTimerStart', newStartTime.getTime());
                }
                location.reload();
            });

            const najdaButton = document.getElementById('najda-button');
            const breathingPage = document.getElementById('breathing-page');
            const closeBreathingBtn = document.getElementById('close-breathing-btn');
            const breathingText = document.getElementById('breathing-text');
            const homePage = document.getElementById('home-page');
            const quotePage = document.getElementById('quote-page');
            const quoteText = document.getElementById('quote-text');
            const closeQuoteBtn = document.getElementById('close-quote-btn');
            const skipToQuoteBtn = document.getElementById('skip-to-quote-btn');
            
            function stopBreathingCycle() {
                breathingTimeouts.forEach(clearTimeout); 
                breathingTimeouts = [];
                if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
            }

            function startBreathingCycle() {
                breathingTimeouts.forEach(clearTimeout);
                breathingTimeouts = [];
                breathingText.textContent = 'شهيق';
                breathingTimeouts.push(setTimeout(() => { breathingText.textContent = 'حبس النفس'; }, 4000));
                breathingTimeouts.push(setTimeout(() => { breathingText.textContent = 'زفير'; }, 11000));
                breathingTimeouts.push(setTimeout(startBreathingCycle, 19000));
            }

            async function showQuotePage() {
                let newImageIndex;
                do { newImageIndex = Math.floor(Math.random() * natureImages.length); } while (newImageIndex === lastImageIndex);
                lastImageIndex = newImageIndex;
                quotePage.style.backgroundImage = `url('${natureImages[newImageIndex]}')`;
                
                breathingPage.classList.remove('active');
                breathingPage.style.display = 'none';
                quotePage.style.display = 'flex';
                quotePage.classList.add('active');
                
                quoteText.textContent = "لحظة من فضلك أفكر في شيء ملهم لك";
                const prompt = "بصفتك ناصح أمين على منهج السلف الصالح خاطب شخص على وشك يطيح في معصية العادة السرية أو مشاهدة الإباحية عطه كلام قوي ومباشر يجمع بين العقل والترهيب والتذكير بعواقب الفعل عشان يتراجع فورا تكلم باللهجة السعودية العامية وردك لازم يكون بدون تشكيل وبدون أي علامات ترقيم نهائيا وخليه قصير ومختصر وطبيعي كأنك تكلم خويك";
                const generatedQuote = await callGeminiAPI(prompt);
                quoteText.innerHTML = generatedQuote;
            }

            function startBreathingExperience() {
                stopBreathingCycle();
                homePage.classList.remove('active');
                breathingPage.style.display = 'flex';
                breathingPage.classList.add('active');
                const breathingTimerEl = document.getElementById('breathing-timer');
                remainingTime = 57;
                breathingTimerEl.textContent = `الوقت المتبقي: ${remainingTime} ثانية`;
                countdownInterval = setInterval(() => {
                    remainingTime--;
                    if (remainingTime >= 0) {
                        breathingTimerEl.textContent = `الوقت المتبقي: ${remainingTime} ثانية`;
                    }
                    if (remainingTime < 0) {
                        stopBreathingCycle();
                        showQuotePage();
                    }
                }, 1000);
                startBreathingCycle();
            }

            najdaButton.addEventListener('click', startBreathingExperience);
            closeBreathingBtn.addEventListener('click', () => {
                stopBreathingCycle();
                breathingPage.classList.remove('active');
                breathingPage.style.display = 'none';
                homePage.classList.add('active');
            });
            closeQuoteBtn.addEventListener('click', () => {
                quotePage.classList.remove('active');
                quotePage.style.display = 'none';
                homePage.classList.add('active');
            });
            skipToQuoteBtn.addEventListener('click', () => {
                stopBreathingCycle();
                showQuotePage();
            });
            
            // --- START: Video Background Logic ---
            const videoElement = document.getElementById('counter-video-bg');
            const overlayElement = document.querySelector('.video-background-overlay');
            const cardElement = document.querySelector('.progress-timer-card');
            const setVideoButton = document.getElementById('set-video-button');
            const removeVideoButton = document.getElementById('remove-video-button');
            const videoFilePicker = document.getElementById('video-file-picker');

            function setCounterBackgroundVideo(videoUrl) {
                if (videoUrl) {
                    cardElement.style.background = 'none';
                    overlayElement.classList.add('visible');
                    videoElement.src = videoUrl;
                    videoElement.classList.add('visible');
                    videoElement.play().catch(e => console.error("Video play failed:", e));
                } else {
                    cardElement.style.background = ''; // Restore gradient
                    overlayElement.classList.remove('visible');
                    videoElement.classList.remove('visible');
                    videoElement.pause();
                    videoElement.src = '';
                }
            }
            
            function listenForBackgroundVideoChanges() {
                const configDocRef = doc(db, "app_config", "background_video");
                onSnapshot(configDocRef, (doc) => {
                    if (doc.exists()) {
                        const videoUrl = doc.data().url;
                        setCounterBackgroundVideo(videoUrl);
                    } else {
                        setCounterBackgroundVideo(null); // No config, reset to default
                    }
                });
            }

            async function uploadVideoToCloudinary(file) {
                const CLOUD_NAME = 'dsf3gudnd';
                const FOLDER = 'back photo';
                const UPLOAD_PRESET = 'back photo'; 

                const url = `https://api.cloudinary.com/v1_1/${CLOUD_NAME}/video/upload`;
                const formData = new FormData();
                formData.append('file', file);
                formData.append('upload_preset', UPLOAD_PRESET);
                formData.append('folder', FOLDER);

                try {
                    setVideoButton.innerHTML = `<span>جاري الرفع... <i class="bi bi-hourglass-split"></i></span>`;
                    setVideoButton.disabled = true;
                    removeVideoButton.disabled = true;

                    const response = await fetch(url, { method: 'POST', body: formData });
                    const data = await response.json();

                    if (data.secure_url) {
                        return data.secure_url;
                    } else {
                        console.error('Cloudinary upload error:', data);
                        alert('حدث خطأ أثناء رفع الفيديو. تأكد من صحة اسم الإعداد المسبق (Upload Preset) في الكود.');
                        return null;
                    }
                } catch (error) {
                    console.error('Fetch error during upload:', error);
                    alert('فشل الاتصال لرفع الفيديو.');
                    return null;
                } finally {
                    setVideoButton.innerHTML = `<span>تعيين خلفية فيديو</span><div class="icon-container green"><i class="bi bi-camera-video-fill"></i></div>`;
                    setVideoButton.disabled = false;
                    removeVideoButton.disabled = false;
                }
            }

            async function updateBackgroundVideoInFirestore(url) {
                const configDocRef = doc(db, "app_config", "background_video");
                try {
                    await setDoc(configDocRef, { url: url }, { merge: true });
                    console.log("Background video URL updated in Firestore.");
                } catch (error) {
                    console.error("Error updating Firestore:", error);
                    alert("خطأ في تحديث قاعدة البيانات.");
                }
            }

            setVideoButton.addEventListener('click', () => videoFilePicker.click());
            removeVideoButton.addEventListener('click', async () => {
                await updateBackgroundVideoInFirestore(null);
                closeSettingsModal();
            });

            videoFilePicker.addEventListener('change', async (event) => {
                const file = event.target.files[0];
                if (file) {
                    const videoUrl = await uploadVideoToCloudinary(file);
                    if (videoUrl) {
                        await updateBackgroundVideoInFirestore(videoUrl);
                        closeSettingsModal();
                    }
                    event.target.value = null; 
                }
            });
            // --- END: Video Background Logic ---

            setupGeminiFeatures();
            setupAiAdviceFeature();
        });
    </script>
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./sw.js')
                    .then(registration => console.log('Unified Service Worker registered successfully.'))
                    .catch(error => console.error('Unified SW registration failed:', error));
            });
        }
    </script>
</body>
</html>

